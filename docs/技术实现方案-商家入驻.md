# 商家入驻审批系统 - 技术实现方案

> **版本**: 1.0  
> **创建时间**: 2025-11-11  
> **作者**: System Team

---

## 1. 技术架构

### 1.1 整体架构

```
┌──────────────┐
│   浏览器     │
└──────┬───────┘
       │
       ↓ HTTP/HTTPS
┌──────────────────────────────────────┐
│         API Gateway (8080)            │
└──────┬────────────────────┬───────────┘
       │                    │
       ↓                    ↓
┌─────────────┐      ┌──────────────┐
│  Merchant   │      │    Admin     │
│  Service    │      │   Service    │
│   (8087)    │      │    (8086)    │
└──────┬──────┘      └──────┬───────┘
       │                    │
       ↓                    ↓
┌──────────────────────────────────────┐
│          MySQL (3307)                 │
│     mall_merchant Database            │
└───────────────────────────────────────┘
       │
       ↓
┌──────────────┐      ┌──────────────┐
│  MinIO(9000) │      │  SMS Service │
│  (图片存储)  │      │    (8089)    │
└──────────────┘      └──────────────┘
```

### 1.2 技术栈

**后端**:
- Spring Boot 3.x
- Spring Data JPA
- MySQL 8.0
- MinIO (对象存储)
- BCrypt (密码加密)

**前端**:
- Vue 3
- Element Plus
- Axios

---

## 2. 数据库设计

### 2.1 ER图

```
merchant_applications          merchant_approval_logs
┌────────────────┐            ┌─────────────────┐
│ id (PK)        │◄───────────│ application_id  │
│ entity_type    │            │ admin_id        │
│ shop_name      │            │ action          │
│ contact_phone  │            │ reason          │
│ username (UK)  │            │ created_time    │
│ approval_status│            └─────────────────┘
│ merchant_id    │
│ created_time   │
└────────────────┘
```

### 2.2 索引策略

**主要索引**:
- `idx_approval_status` - 状态查询优化
- `idx_created_time` - 时间排序优化
- `idx_username` - 唯一性检查优化
- `idx_contact_phone` - 手机号查询优化

---

## 3. 核心业务逻辑

### 3.1 申请提交流程

```java
@Transactional
public Long submitApplication(Request request) {
    1. 数据验证
       - 必填字段检查
       - 格式验证（手机号、邮箱等）
       - 账号唯一性检查
    
    2. 密码加密
       - 使用BCrypt加密
       - 强度：10轮
    
    3. 保存申请
       - 状态：待审核(0)
       - 记录提交时间
    
    4. 返回申请ID
}
```

### 3.2 审批操作流程

```java
@Transactional(rollbackFor = Exception.class)
public void approveApplication(Long id, ApprovalRequest request, Long adminId) {
    1. 查询申请
       - 验证申请存在
       - 检查当前状态
    
    2. 状态检查
       - 防止重复审批
       - 只能审批待审核状态
    
    3. 更新审批状态
       - 设置审批结果
       - 记录审批原因
       - 记录审批人和时间
    
    4. 创建商家账号（通过时）
       - 复制申请信息
       - 创建Merchant实体
       - 设置初始权限
    
    5. 记录审批日志
       - 操作人
       - 操作时间
       - 操作IP
       - 审批结果
    
    6. 发送短信通知
       - 异步发送
       - 失败不影响主流程
       - 记录发送状态
}
```

---

## 4. 安全机制

### 4.1 密码安全

- **加密算法**: BCrypt
- **加密强度**: 10 rounds
- **密码要求**: 6-20位字符

### 4.2 数据脱敏

```java
// 手机号脱敏：138****8000
String masked = phone.replaceAll("(\\d{3})\\d{4}(\\d{4})", "$1****$2");

// 身份证脱敏：110101********1234
String masked = idCard.replaceAll("(\\d{6})\\d+(\\d{4})", "$1********$2");
```

### 4.3 操作审计

所有审批操作记录：
- 操作人ID和用户名
- 操作时间
- 操作IP地址
- 操作内容（通过/拒绝+原因）

---

## 5. 短信通知

### 5.1 通知时机

| 事件 | 触发时机 | 接收人 |
|------|---------|--------|
| 申请提交 | 提交成功后 | 申请人 |
| 审批通过 | 管理员点击通过 | 申请人 |
| 审批拒绝 | 管理员点击拒绝 | 申请人 |

### 5.2 短信模板

见《API文档-商家入驻审批.md》短信通知部分。

### 5.3 重试机制

- 初次发送失败后自动重试
- 最多重试3次
- 重试间隔：2秒
- 记录重试次数到数据库

---

## 6. 异常处理

### 6.1 业务异常

| 异常 | 处理方式 |
|------|---------|
| 账号已存在 | 提示用户更换账号 |
| 重复审批 | 阻止操作并提示 |
| 审批拒绝未填原因 | 前端和后端双重验证 |

### 6.2 系统异常

| 异常 | 处理方式 |
|------|---------|
| 数据库连接失败 | 事务回滚，返回500错误 |
| MinIO上传失败 | 提示重新上传 |
| SMS发送失败 | 记录失败，不影响审批 |

---

## 7. 性能优化

### 7.1 数据库优化

- 使用索引优化查询
- 分页查询避免全表扫描
- 使用HikariCP连接池

### 7.2 接口优化

- 列表接口使用分页
- 图片使用MinIO CDN加速
- 短信异步发送
- 审批日志异步记录

---

## 8. 部署说明

### 8.1 服务依赖

商家入驻审批系统依赖以下服务：

1. **MySQL** (3307) - 数据存储
2. **MinIO** (9000) - 图片存储  
3. **SMS Service** (8089) - 短信通知
4. **Merchant Service** (8087) - 商家服务
5. **Admin Service** (8086) - 管理服务

### 8.2 启动顺序

1. MySQL
2. MinIO
3. SMS Service
4. Merchant Service
5. Admin Service
6. Gateway
7. Frontend

---

## 9. 测试用例

### 9.1 申请提交测试

```bash
curl -X POST http://localhost:8080/api/merchants/apply \
  -H "Content-Type: application/json" \
  -d '{
    "entityType": "enterprise",
    "shopType": "flagship",
    "shopName": "测试旗舰店",
    "contactName": "张三",
    "contactPhone": "13800138000",
    "email": "test@example.com",
    "companyName": "测试科技有限公司",
    "creditCode": "91110000MA001234AB",
    "legalPerson": "张三",
    "businessLicense": "http://localhost:9000/mall-avatars/test.jpg",
    "username": "test_merchant_001",
    "password": "test123456"
  }'
```

预期结果: 返回申请ID

### 9.2 审批测试

```bash
# 先登录管理员获取token
curl -X POST http://localhost:8082/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 使用token审批
curl -X PUT http://localhost:8080/api/admin/merchants/applications/1/approve \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"approved": true, "reason": "审核通过"}'
```

预期结果: 
- 审批状态更新
- 创建商家账号
- 发送短信通知

---

## 10. 监控与日志

### 10.1 关键日志

```
[INFO] 商家入驻申请提交成功 - 申请ID: 1, 店铺名称: 测试旗舰店
[INFO] 商家申请审批成功 - ID: 1, 结果: 通过
[INFO] 商家账号创建成功 - ID: 100
[INFO] 审批短信发送成功 - 手机: 13800138000
```

### 10.2 监控指标

- 每日申请提交量
- 审批通过率
- 平均审批时长
- 短信发送成功率

---

*文档版本: 1.0*  
*最后更新: 2025-11-11*







