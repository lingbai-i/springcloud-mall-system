# 基于 Spring Cloud 的微服务在线商城 — 技术栈设计

来源与依据：
- 需求文件：在线商城需求说明.md
- 系统功能架构初步设计图.png

## 1. 架构总览
- 架构风格：Spring Cloud Alibaba 微服务 + 事件驱动（最终一致）
- 通信：HTTP/REST（外部/网关）、gRPC/Feign（内部可扩展，当前使用 OpenFeign）
- 运行：容器化（Docker），编排（Kubernetes，开发期 docker-compose）
- 环境：dev / stage / prod 三套；配置与开关集中托管

## 2. 后端技术栈
- 核心框架
  - Java 22 + Spring Boot 3.x
  - Spring Cloud Alibaba：
    - Nacos：注册发现 + 配置中心（多命名空间：dev/stage/prod）
    - Spring Cloud Gateway：统一网关、鉴权、限流、灰度
    - OpenFeign：服务间声明式调用
    - Sentinel：限流、熔断、隔离与降级
    - Seata：分布式事务（TCC/Saga/AT，按业务选择，优先事件驱动）
    - RocketMQ：事务消息/事件总线（下单→库存、支付回调、退款、索引同步）
- 数据与缓存
  - MySQL 8（按域分库，读写分离预留），MyBatis-Plus（审计字段/通用 CRUD）
  - Redis Cluster：缓存、分布式锁、限流计数、会话黑名单
  - Elasticsearch 8：商品与内容检索（search-service 专用）
  - MinIO（S3 兼容）：媒体与文件（本地/测试），生产可对接云 OSS
- 安全与认证
  - Spring Authorization Server 或 Keycloak（OAuth 2.1 / OIDC）
  - Spring Security Resource Server + JWT（网关与服务间鉴权）
  - 数据域隔离（用户/店铺/角色），审计与审批流在 admin/merchant 侧落地
- 可观测与日志
  - OpenTelemetry（Trace/Metrics/Logs） + Prometheus + Grafana
  - 日志：Loki 或 ELK（Filebeat/Logstash/ES/Kibana）
  - 全链路追踪（网关→服务→DB/MQ），关键操作审计独立索引
- 任务与调度
  - XXL-Job：对账、重算、索引重建、定时上下线
- API 文档与契约
  - SpringDoc OpenAPI 3 + Swagger UI；网关聚合文档

## 3. 微服务划分（与需求对齐）
- 基础能力：gateway-service、auth-service、notify-service（短信/邮件/站内信）
- 用户域：user-service（账号、资料、地址、设备）
- 商品域：product-service（SPU/SKU/类目/上架）、search-service（ES 索引/查询）
- 交易域：cart-service、order-service、inventory-service、payment-service、refund-service
- 商家域：merchant-service（入驻/店铺/成员/权限/发货/售后协同）
- 账务域：settlement-service（结算/对账/分账）、withdrawal-service（提现）
- 运营域：cms-service（内容/素材/发布）、coupon-service（优惠与促销）
- 管理域：admin-service（RBAC/菜单/审计/系统开关）

依赖示例：
- 下单：cart → order → inventory(占用) → payment(可选预创建) → settlement(事件)
- 发货：merchant → order(发货/物流) → notify → settlement
- 售后：order/refund ↔ payment ↔ settlement；inventory（逆向补库存）

## 4. 前端技术栈（Vue3 + JavaScript）
- 框架与构建：Vite + Vue 3（Composition API，纯 JS）
- 路由与状态：Vue Router 4、Pinia（持久化插件）
- UI/交互：Element Plus、VueUse、vee-validate + yup（表单）
- 网络：Axios 单例 + 拦截器（JWT、重试、统一错误处理），baseURL 指向网关
- 质量：ESLint + Prettier + Husky + lint-staged；Vitest（单测）、Playwright（E2E）
- 性能：按路由与组件分包、CDN 与缓存策略、图片延迟加载
- 埋点：简单埋点 SDK（PV/UV/事件），Sentry 可选

## 5. 配置与环境
- Nacos：多命名空间；按服务分 Group；典型配置项：限流阈值、降级开关、灰度规则、第三方密钥引用（只存引用不存明文）
- 环境变量：数据库/Redis/MQ/ES/OSS 地址、证书路径；K8s Secret 管理密钥

## 6. 接口与安全约定
- 统一从网关访问；游客/买家/商家/后台用 Scope/Role 鉴权与路由隔离
- 幂等：订单创建、支付回调、退款执行使用幂等键（业务主键 + 去重表或 Redis）
- 传输安全：HTTPS、签名与时间戳（支付/退款类接口），重放防护

## 7. 交付与运维
- 容器：Dockerfile 多阶段构建，最小化镜像；健康检查与优雅停机
- 编排：Kubernetes + Helm（分环境 values）；灰度：金丝雀/蓝绿
- CI/CD：Jenkins/GitHub Actions（构建→测试→镜像→Helm 部署→验收）

## 8. 代码结构建议（Monorepo + Maven 多模块）
- common-bom、common-core（异常/返回体/拦截器/幂等/日志）、common-security
- gateway-service、auth-service、user-service、product-service、…（各域服务）
- frontend/portal-vue（买家端，Vue3 JS）、frontend/merchant-vue（可选）
- deploy/docker、deploy/helm、docs（设计文档）

## 9. 测试策略
- 单元/集成：JUnit5 + Testcontainers（MySQL/Redis/MQ/ES）
- 契约：Spring Cloud Contract（服务与网关）
- E2E：Playwright（下单/发货/售后/结算路径）
- 压测：JMeter/Gatling + PromQL 指标验收

## 10. 非功能性要求
- 可用性：核心链路 99.9%；峰值时通过限流/降级保护
- 可观测：关键业务 SLI/SLO；异常自动告警；审计可追溯
- 合规与安全：最小权限、数据脱敏、敏感操作审批与审计