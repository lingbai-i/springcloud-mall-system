## 前置准备
- 选择业务低峰期进行操作，提前发布维护通知
- 全量数据备份（数据库与重要文件），确保可回滚
- 准备运维账号与权限（MySQL、Docker、Nacos、服务器）

## 步骤 1：停止所有运行服务
- 前端开发服务器（Vite）：关闭浏览器与终端，或 PowerShell 执行：`taskkill /F /IM node.exe`
- Java 后端进程：`Get-Process java -ErrorAction SilentlyContinue | Stop-Process -Force`
- Docker Compose（如使用容器）：在项目根目录执行：`docker-compose down`
- 可优先使用仓库脚本（如存在）：
  - `stop-dev-silent.bat` 安静停止
  - `service-manager.bat`/`diagnose.bat` 检查与辅助停止

## 步骤 2：清理临时文件与缓存
- Maven 构建输出：在项目根目录执行：`mvn -T 1C clean`
- 删除各后端模块 `target` 目录（如需）：`Get-ChildItem backend -Filter target -Recurse | Remove-Item -Recurse -Force`
- 前端依赖缓存：`npm ci`（自动清理并重装），如需彻底清理：`Remove-Item -Recurse -Force node_modules`；`Remove-Item -Recurse -Force .vite`（若存在）
- Nacos/Redis 本地缓存（可选）：按需清理本机开发缓存（谨慎执行）

## 步骤 3：检查并更新依赖到指定版本
- 后端依赖：`mvn -T 1C -DskipTests clean package`
  - 如需强制刷新快照/插件：`mvn -U -DskipTests clean package`
- 前端依赖：`npm ci`（遵循 `package-lock.json` 指定版本）
- 确认关键依赖版本：Spring Boot、Spring Cloud、Knife4j/springdoc、Axios/Element Plus 等

## 步骤 4：数据库备份与初始化检查
- 备份所有业务库（从 `sql/init-databases.sql`）：
  - `mall_gateway mall_auth mall_user mall_product mall_cart mall_order mall_payment mall_merchant mall_admin`
- 备份命令示例（PowerShell）：
  - `mysqldump -h localhost -P 3307 -u root -p123456 mall_merchant > backup/mall_merchant_YYYYMMDD.sql`
  - 其余库按需备份；端口与密码参照各服务 `application.yml`
- 验证数据库连接：检查后端各服务的 `spring.datasource.url/username/password`（例如商家服务位于 `backend/merchant-service/src/main/resources/application.yml`）

## 步骤 5：按正确顺序启动各模块
- 基础设施（容器）：`docker-compose up -d redis mysql nacos rabbitmq rocketmq`（按需）
- 网关服务：`docker-compose up -d gateway-service` 或本机 `java -jar` 启动
- 后端微服务（建议顺序）：
  - `auth-service`、`user-service`
  - `product-service`、`cart-service`
  - `order-service`、`payment-service`
  - `merchant-service`、`admin-service`
  - `sms-service`
- 前端开发服务器：在 `frontend` 目录执行 `npm run dev`（端口 `5173`）
- 可使用仓库脚本：`start-dev.bat`、`start-dev-debug.bat`、`start-dev-silent.bat` 进行一键启动

## 步骤 6：健康检查与路由确认（通过网关）
- 网关健康：`GET http://localhost:8080/actuator/health` 应返回 `{"status":"UP"}`
- 各服务健康（通过网关路径）：
  - 用户服务：`GET http://localhost:8080/api/users/actuator/health` 或 `GET http://localhost:8080/api/user-service/actuator/health`
  - 商品服务：`GET http://localhost:8080/api/product/actuator/health`
  - 购物车服务：`GET http://localhost:8080/api/cart/actuator/health`
  - 订单服务：`GET http://localhost:8080/api/order/actuator/health`
  - 支付服务：`GET http://localhost:8080/api/payment/actuator/health`
  - 商家服务（单数）：`GET http://localhost:8080/api/merchant/actuator/health`
  - 商家服务（复数）：`GET http://localhost:8080/api/merchants/actuator/health`
  - 管理服务：`GET http://localhost:8080/api/admin/actuator/health`
  - 短信服务：`GET http://localhost:8080/api/sms/actuator/health`

## 步骤 7：功能验证（关键用例）
- 管理员审核页加载：访问 `http://localhost:5173/admin/merchants/applications`
  - 列表接口：`GET /api/admin/merchants/applications?page=1&size=20&keyword=` 应返回 200 且包含 `records/total/current/pages`
  - 统计接口：`GET /api/admin/merchants/applications/stats` 返回 200
- 商家申请提交流程：
  - `POST /api/merchants/apply` 提交后返回 `applicationId`，数据库表 `merchant_applications` 出现新记录
- 其他基础功能抽查：用户登录、商品列表、下单、支付、短信发送等

## 日志监控与异常处理
- 网关与服务日志（容器）：`docker-compose logs -f gateway-service admin-service merchant-service sms-service`
- 本机 Java 控制台日志：直接观察启动终端输出；如落地到文件，使用：`Get-Content -Wait logs/<service>.log`
- 前端网络日志：DevTools → Network；如遇错误，导出 HAR 供诊断
- 统一请求追踪：前端已添加 `X-Request-ID`，后端日志根据该 ID 关联链路

## 备份与回滚策略
- 如出现路由/认证配置异常：回滚到先前 `application.yml` 或控制器映射设置
- 数据异常：从备份 SQL 恢复到新建数据库或原库（按需）
- 前端依赖冲突：使用 `npm ci` 回滚到锁定版本；后端使用父 POM 版本固定策略进行回滚

## 注意事项
- 严禁在高峰期重启；重启过程全程监控日志
- 各模块启动超时与端口占用需即时处理（变更端口或清理僵尸进程）
- Swagger 文档验证：
  - 商家服务 Knife4j：`http://localhost:8080/api/merchants/doc.html`
  - 短信服务 springdoc：`http://localhost:8080/api/sms/swagger-ui.html` 与 `http://localhost:8080/api/sms/v3/api-docs`

若需要，我可以在你确认后：
- 自动执行上述停止、清理、构建与启动步骤
- 采集 HAR、健康检查结果与关键日志
- 对管理员审核页进行端到端自动化验证并提供截图