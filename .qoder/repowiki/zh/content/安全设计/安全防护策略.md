# 安全防护策略

<cite>
**本文档引用文件**  
- [SecurityConfig.java](file://backend/auth-service/src/main/java/com/mall/auth/config/SecurityConfig.java)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java)
- [SecurityConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java)
- [CorsConfig.java](file://backend/sms-service/src/main/java/com/mall/sms/config/CorsConfig.java)
- [JwtAuthenticationEntryPoint.java](file://backend/cart-service/src/main/java/com/mall/cart/security/JwtAuthenticationEntryPoint.java)
- [JwtAuthenticationEntryPoint.java](file://backend/user-service/src/main/java/com/mall/user/security/JwtAuthenticationEntryPoint.java)
- [JwtAuthenticationFilter.java](file://backend/cart-service/src/main/java/com/mall/cart/security/JwtAuthenticationFilter.java)
- [JwtAuthenticationFilter.java](file://backend/user-service/src/main/java/com/mall/user/security/JwtAuthenticationFilter.java)
</cite>

## 目录
1. [引言](#引言)
2. [CSRF防护策略](#csrf防护策略)
3. [CORS跨域配置](#cors跨域配置)
4. [无状态会话管理](#无状态会话管理)
5. [URL级别访问控制](#url级别访问控制)
6. [异常处理机制](#异常处理机制)
7. [环境安全配置差异](#环境安全配置差异)
8. [安全最佳实践](#安全最佳实践)

## 引言
本安全防护策略文档系统阐述了SpringCloud微服务架构下的安全体系设计。系统采用Spring Security框架构建统一的安全防护机制，结合JWT（JSON Web Token）实现无状态认证，确保各服务在分布式环境下的安全通信与访问控制。文档详细说明了CSRF防护、CORS跨域、会话管理、URL权限控制、异常处理等核心安全组件的实现方案，并对比了开发与生产环境的配置差异，为系统的安全运维提供指导。

## CSRF防护策略
系统在所有微服务中均禁用了CSRF（跨站请求伪造）防护机制。由于本系统采用前后端分离架构，通过JWT进行身份认证，而非传统的基于Cookie和Session的认证方式，因此无需CSRF防护。

CSRF防护的禁用通过在`SecurityConfig`配置类中调用`.csrf().disable()`实现。例如，在`auth-service`中，通过`@Value("${security.csrf-enabled:false}")`配置项控制是否启用CSRF，开发环境下默认为`false`，即禁用状态。该设计符合RESTful API无状态安全的最佳实践，避免了不必要的安全开销。

**Section sources**
- [SecurityConfig.java](file://backend/auth-service/src/main/java/com/mall/auth/config/SecurityConfig.java#L58-L65)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L57-L58)
- [SecurityConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java#L38-L39)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java#L43-L44)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L83-L84)

## CORS跨域配置
系统通过Spring Security的CORS配置机制，统一管理跨域资源共享策略，确保前端应用能够安全地访问后端API。

### 允许的源
- `sms-service`允许所有域名访问（`allowedOriginPatterns("*")`），适用于短信服务的开放接口。
- `user-service`明确允许本地开发环境的前端地址，包括`http://localhost:5173`、`http://localhost:5174`等，确保开发调试的安全性。

### 允许的方法
所有服务均允许`GET`、`POST`、`PUT`、`DELETE`、`OPTIONS`等标准HTTP方法，满足RESTful API的完整操作需求。

### 允许的头信息
配置中设置`allowedHeaders("*")`，允许所有请求头，确保自定义头（如`Authorization`）能够正常传递。

CORS配置通过`CorsConfigurationSource` Bean实现，注册`/**`路径的全局规则。例如，`cart-service`和`payment-service`均采用`setAllowedOriginPatterns(Arrays.asList("*"))`实现灵活的跨域策略。

**Section sources**
- [CorsConfig.java](file://backend/sms-service/src/main/java/com/mall/sms/config/CorsConfig.java#L20-L27)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L94-L105)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java#L124-L147)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L131-L157)

## 无状态会话管理
系统采用STATELESS（无状态）会话管理策略，完全依赖JWT进行用户身份认证，不使用服务器端Session存储。

该策略通过在`SecurityConfig`中配置`.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)`实现。所有服务如`auth-service`、`cart-service`、`payment-service`等均采用此配置，确保服务的可伸缩性和高可用性。用户认证信息全部编码在JWT中，由客户端在每次请求时通过`Authorization`头携带，服务端通过`JwtAuthenticationFilter`解析和验证Token。

**Section sources**
- [SecurityConfig.java](file://backend/auth-service/src/main/java/com/mall/auth/config/SecurityConfig.java#L79-L82)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L61-L62)
- [SecurityConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java#L41-L42)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java#L51-L53)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L87-L88)

## URL级别访问控制
系统通过`authorizeHttpRequests`配置实现精细化的URL访问控制，定义了公开接口、认证接口和角色限制接口的访问规则。

### 配置模式
使用`requestMatchers()`方法匹配特定路径，并结合`permitAll()`、`authenticated()`、`hasRole()`等方法定义访问策略。

### 具体规则
- **公开接口**：如`/actuator/**`、`/swagger-ui/**`、`/auth/**`、`/users/login`等，允许匿名访问。
- **认证接口**：如`/api/payment/orders/**`，要求用户已认证，通常使用`.authenticated()`或`.hasAnyRole("USER", "ADMIN")`。
- **角色限制接口**：如`/api/payment/risk/**`要求`ADMIN`角色，`/api/payment/admin/**`要求`SUPER_ADMIN`角色，通过`.hasRole()`精确控制。

例如，`payment-service`的配置清晰地划分了健康检查、支付、风控、统计和管理等不同层级的权限。

**Section sources**
- [SecurityConfig.java](file://backend/auth-service/src/main/java/com/mall/auth/config/SecurityConfig.java#L68-L77)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L73-L83)
- [SecurityConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java#L45-L47)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java#L58-L91)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L98-L117)

## 异常处理机制
系统通过自定义`AuthenticationEntryPoint`和`AccessDeniedHandler`实现统一的认证和授权异常处理。

### AuthenticationEntryPoint
当用户未认证（未登录）时触发。系统实现了`JwtAuthenticationEntryPoint`，返回401状态码和JSON格式的错误信息，如`"未认证，请先登录"`。该实现位于`cart-service`和`user-service`中，确保前端能正确处理未登录状态。

### AccessDeniedHandler
当已认证用户权限不足时触发。`payment-service`中定义了`CustomAccessDeniedHandler`，返回403状态码和`"权限不足"`的提示。

这些处理器通过`.exceptionHandling()`配置注入到安全过滤链中，提供一致的API错误响应。

**Section sources**
- [JwtAuthenticationEntryPoint.java](file://backend/cart-service/src/main/java/com/mall/cart/security/JwtAuthenticationEntryPoint.java#L24-L46)
- [JwtAuthenticationEntryPoint.java](file://backend/user-service/src/main/java/com/mall/user/security/JwtAuthenticationEntryPoint.java#L16-L31)
- [SecurityConfig.java](file://backend/payment-service/src/main/java/com/mall/payment/config/SecurityConfig.java#L95-L97)

## 环境安全配置差异
系统通过配置文件实现了开发与生产环境的安全策略差异化。

### JWT开关
核心差异在于JWT认证的启用状态。通过`@Value("${security.jwt.enabled:true}")`配置项控制，`true`为生产模式（启用JWT），`false`为开发模式（禁用JWT）。

- **开发环境**：当`jwtEnabled`为`false`时，`user-service`和`cart-service`直接放行所有请求（`.anyRequest().permitAll()`），极大方便了开发和调试。
- **生产环境**：`jwtEnabled`为`true`，强制执行JWT认证和权限检查。

该机制通过`@PostConstruct`注解的日志输出进行验证，如`[SecurityConfig] JWT认证已启用 (security.jwt.enabled=true)`。

**Section sources**
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L44-L61)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L32-L33)
- [SecurityConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/SecurityConfig.java#L90-L121)
- [SecurityConfig.java](file://backend/cart-service/src/main/java/com/mall/cart/config/SecurityConfig.java#L64-L67)

## 安全最佳实践
1. **最小权限原则**：URL访问控制遵循最小权限，避免过度授权。
2. **配置驱动**：关键安全开关（如JWT启用）通过配置文件控制，无需修改代码。
3. **日志审计**：`JwtAuthenticationFilter`和`JwtAuthenticationEntryPoint`中包含详细的日志记录，便于安全审计和问题排查。
4. **防御性编程**：`JwtAuthenticationFilter`中对Token解析进行异常捕获，防止因Token问题导致服务崩溃。
5. **标准化响应**：异常处理返回结构化的JSON响应，与业务API保持一致，提升前端处理体验。