# 订单模型

<cite>
**本文档引用文件**  
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java)
- [OrderItem.java](file://backend/order-service/src/main/java/com/mall/order/entity/OrderItem.java)
- [OrderStatus.java](file://backend/order-service/src/main/java/com/mall/order/enums/OrderStatus.java)
- [数据字典.md](file://数据字典.md)
</cite>

## 目录
1. [订单主表（orders）字段定义](#订单主表orders字段定义)
2. [订单明细表（order_items）字段定义](#订单明细表order_items字段定义)
3. [订单金额计算逻辑](#订单金额计算逻辑)
4. [订单状态机流转规则](#订单状态机流转规则)
5. [订单与用户、商品的关联关系](#订单与用户商品的关联关系)
6. [商品快照设计目的](#商品快照设计目的)
7. [订单与支付记录关系](#订单与支付记录关系)
8. [订单超时关闭策略](#订单超时关闭策略)
9. [订单数据归档策略](#订单数据归档策略)
10. [ER图：订单模型关系](#er图订单模型关系)

## 订单主表（orders）字段定义

订单主表 `orders` 存储订单的核心信息，包含订单编号、金额、状态、收货信息等。以下是字段详细定义：

| 字段名 | 数据类型 | 是否为空 | 默认值 | 约束 | 描述 |
|--------|--------|--------|--------|--------|--------|
| id | BIGINT | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 订单唯一标识ID |
| order_no | VARCHAR(32) | NOT NULL | - | UNIQUE KEY | 订单编号，全局唯一 |
| user_id | BIGINT | NOT NULL | - | INDEX | 用户ID，关联用户表 |
| product_amount | DECIMAL(10,2) | NOT NULL | - | - | 商品总金额（不含运费） |
| freight_amount | DECIMAL(10,2) | NOT NULL | 0.00 | - | 运费金额 |
| discount_amount | DECIMAL(10,2) | NOT NULL | 0.00 | - | 优惠金额 |
| total_amount | DECIMAL(10,2) | NOT NULL | - | INDEX | 订单总金额 |
| pay_amount | DECIMAL(10,2) | NOT NULL | - | - | 实付金额 |
| pay_method | VARCHAR(20) | YES | - | - | 支付方式（如微信、支付宝） |
| status | VARCHAR(20) | NOT NULL | - | INDEX | 订单状态（枚举值） |
| receiver_name | VARCHAR(50) | NOT NULL | - | - | 收货人姓名 |
| receiver_phone | VARCHAR(20) | NOT NULL | - | - | 收货人电话 |
| receiver_address | VARCHAR(200) | NOT NULL | - | - | 收货地址 |
| pay_time | DATETIME | YES | - | INDEX | 支付时间 |
| ship_time | DATETIME | YES | - | - | 发货时间 |
| confirm_time | DATETIME | YES | - | - | 确认收货时间 |
| cancel_time | DATETIME | YES | - | - | 取消时间 |
| cancel_reason | VARCHAR(200) | YES | - | - | 取消原因 |
| logistics_company | VARCHAR(50) | YES | - | - | 物流公司 |
| logistics_no | VARCHAR(50) | YES | - | - | 物流单号 |
| tracking_no | VARCHAR(50) | YES | - | - | 物流跟踪号 |
| payment_id | VARCHAR(50) | YES | - | - | 支付系统交易ID |
| remark | VARCHAR(500) | YES | - | - | 订单备注 |
| create_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP | INDEX | 创建时间 |
| update_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |

**订单编号（order_no）唯一性说明**：  
`order_no` 字段设置为唯一索引（UNIQUE KEY），确保每个订单编号在系统中唯一。订单号生成策略由服务端实现，通常结合时间戳、用户ID、随机数等生成全局唯一编号，防止重复创建。

**Section sources**
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java#L36-L37)
- [数据字典.md](file://数据字典.md#L149)

## 订单明细表（order_items）字段定义

订单明细表 `order_items` 存储订单中每个商品的详细信息，与订单主表通过 `order_id` 关联。

| 字段名 | 数据类型 | 是否为空 | 默认值 | 约束 | 描述 |
|--------|--------|--------|--------|--------|--------|
| id | BIGINT | NOT NULL | AUTO_INCREMENT | PRIMARY KEY | 订单项唯一标识 |
| order_id | BIGINT | NOT NULL | - | INDEX, FOREIGN KEY | 所属订单ID |
| product_id | BIGINT | NOT NULL | - | INDEX | 商品ID |
| productName | VARCHAR(200) | NOT NULL | - | - | 商品名称（快照） |
| productImage | VARCHAR(500) | YES | - | - | 商品图片URL（快照） |
| productSpec | VARCHAR(200) | YES | - | - | 商品规格（如颜色、尺寸） |
| productPrice | DECIMAL(10,2) | NOT NULL | - | - | 商品单价（快照） |
| quantity | INTEGER | NOT NULL | - | - | 购买数量 |
| subtotal | DECIMAL(10,2) | NOT NULL | - | - | 小计金额（单价 × 数量） |
| create_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE | - | 更新时间 |

**小计金额计算逻辑**：  
在 `OrderItem` 实体中，通过 `@PrePersist` 和 `@PreUpdate` 注解，在保存或更新前自动调用 `calculateSubtotal()` 方法，计算 `subtotal = productPrice × quantity`。

**Section sources**
- [OrderItem.java](file://backend/order-service/src/main/java/com/mall/order/entity/OrderItem.java#L34-L77)
- [数据字典.md](file://数据字典.md#L180-L186)

## 订单金额计算逻辑

订单金额的计算遵循以下公式：

```
订单总金额 = 商品总金额 + 运费 - 优惠金额
实付金额 = 订单总金额（默认情况下）
```

在 `Order` 实体类中，`calculateTotalAmount()` 方法实现了该逻辑：

```java
public void calculateTotalAmount() {
    this.totalAmount = this.productAmount
            .add(this.freightAmount)
            .subtract(this.discountAmount);
    this.payAmount = this.totalAmount;
}
```

- `product_amount`：从购物车或商品服务获取商品总价
- `freight_amount`：根据收货地址和重量计算运费，若未设置则默认为0
- `discount_amount`：应用优惠券或促销活动后的减免金额，若无优惠则为0

该方法在订单创建或更新时调用，确保金额一致性。

**Section sources**
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java#L247-L252)

## 订单状态机流转规则

订单状态由 `OrderStatus` 枚举定义，包含以下状态：

| 状态代码 | 状态描述 | 可流转至 |
|--------|--------|--------|
| pending | 待付款 | paid, cancelled |
| paid | 已付款 | shipped, cancelled |
| shipped | 已发货 | completed, refunded |
| completed | 已完成 | refunded |
| cancelled | 已取消 | - |
| refunding | 退款中 | refunded |
| refunded | 已退款 | - |

**状态流转规则**：
- **待付款 → 已付款**：用户完成支付后，系统更新状态并记录 `pay_time`
- **待付款 → 已取消**：用户主动取消或系统超时未支付自动取消
- **已付款 → 已发货**：商家操作发货，更新 `ship_time` 和物流信息
- **已发货 → 已完成**：用户确认收货或系统自动确认（默认15天）
- **已发货 → 退款中**：用户申请退款，进入退款流程
- **已完成 → 退款中**：用户在售后期内申请退货退款

**状态变更校验方法**：
- `canCancel()`：仅 `pending` 和 `paid` 状态可取消
- `canRefund()`：`paid`、`shipped`、`completed` 状态可申请退款
- `canConfirm()`：仅 `shipped` 状态可确认收货

**Section sources**
- [OrderStatus.java](file://backend/order-service/src/main/java/com/mall/order/enums/OrderStatus.java#L16-L56)
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java#L259-L278)

## 订单与用户、商品的关联关系

订单系统通过外键和远程调用实现与用户、商品的关联：

- **订单与用户**：  
  `orders` 表中的 `user_id` 字段关联 `users` 表，用于标识订单归属。用户信息通过 `user-service` 远程调用获取。

- **订单与商品**：  
  `order_items` 表中的 `product_id` 关联 `products` 表。下单时从 `product-service` 获取商品信息并保存为快照，避免后续商品信息变更影响订单。

- **订单与商家**：  
  订单中隐含 `merchant_id`（未在字段中显式列出），用于标识商品所属商家，支持多商家电商平台场景。

**Section sources**
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java#L42)
- [OrderItem.java](file://backend/order-service/src/main/java/com/mall/order/entity/OrderItem.java#L40)

## 商品快照设计目的

订单明细表中保存商品信息（名称、图片、价格、规格）作为**快照**，主要目的包括：

1. **数据一致性**：防止商品信息修改后影响历史订单展示
2. **审计追溯**：保留下单时的商品状态，便于售后和纠纷处理
3. **性能优化**：避免每次查询订单时都调用商品服务，提升响应速度
4. **离线可用**：即使商品服务不可用，仍可正常展示订单详情

快照数据在订单创建时从商品服务获取并固化，后续不再更新。

**Section sources**
- [OrderItem.java](file://backend/order-service/src/main/java/com/mall/order/entity/OrderItem.java#L46-L65)

## 订单与支付记录关系

订单与支付记录通过 `order_no` 和 `payment_id` 关联：

- `orders` 表中的 `order_no` 对应 `payment_records` 表中的 `order_no`
- `orders` 表中的 `payment_id` 对应支付系统的交易流水号
- 支付成功后，支付服务通过回调更新订单状态为 `paid`，并记录 `pay_time`

该设计实现订单与支付的解耦，支持异步通知和对账。

**Section sources**
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java#L157-L158)
- [数据字典.md](file://数据字典.md#L288)

## 订单超时关闭策略

系统通过定时任务自动关闭超时未支付订单：

- **超时时间**：默认30分钟（可配置）
- **执行机制**：使用 `@Scheduled` 定时任务，每5分钟扫描一次待付款订单
- **分布式锁**：通过 Redis 实现分布式锁，防止多实例重复处理
- **状态更新**：将超时订单状态更新为 `cancelled`，并释放库存

相关代码位于 `OrderTask.java` 中的 `closeTimeoutOrders()` 方法。

**Section sources**
- [OrderTask.java](file://backend/order-service/src/main/java/com/mall/order/task/OrderTask.java#L69-L84)

## 订单数据归档策略

为提升查询性能和控制数据库容量，系统实施订单数据归档：

- **归档条件**：订单状态为 `completed` 或 `cancelled` 且距完成时间超过1年
- **归档方式**：将数据迁移至历史订单表或数据仓库
- **清理机制**：通过 `MerchantStatisticsServiceImpl` 提供的 `cleanupExpiredStatistics` 接口定期清理
- **索引优化**：对 `create_time` 和 `status` 建立复合索引，加速归档查询

归档后数据仍可通过报表系统查询，确保业务可追溯。

**Section sources**
- [MerchantStatisticsServiceImpl.java](file://backend/merchant-service/src/main/java/com/mall/merchant/service/impl/MerchantStatisticsServiceImpl.java#L930-L973)

## ER图：订单模型关系

```mermaid
erDiagram
orders ||--o{ order_items : "包含"
orders }|--|| users : "属于"
order_items }|--|| products : "对应商品"
orders }|--|| payment_records : "支付记录"
orders {
bigint id PK
varchar(32) order_no UK
bigint user_id FK
decimal(10,2) total_amount
decimal(10,2) pay_amount
decimal(10,2) freight_amount
decimal(10,2) discount_amount
varchar(20) status
varchar(50) receiver_name
varchar(20) receiver_phone
varchar(200) receiver_address
datetime pay_time
datetime ship_time
datetime confirm_time
datetime cancel_time
varchar(200) cancel_reason
varchar(50) logistics_company
varchar(50) logistics_no
varchar(50) tracking_no
varchar(50) payment_id
varchar(500) remark
datetime create_time
datetime update_time
}
order_items {
bigint id PK
bigint order_id FK
bigint product_id
varchar(200) product_name
varchar(500) product_image
varchar(200) product_spec
decimal(10,2) product_price
int quantity
decimal(10,2) subtotal
datetime create_time
datetime update_time
}
users {
bigint id PK
varchar(50) username
varchar(100) email
varchar(20) phone
varchar(50) nickname
tinyint status
}
products {
bigint id PK
varchar(255) name
bigint category_id
varchar(100) brand
decimal(10,2) price
int stock
varchar(255) main_image
tinyint status
}
payment_records {
bigint id PK
varchar(32) payment_no UK
varchar(32) order_no
bigint user_id
decimal(10,2) amount
tinyint payment_type
varchar(50) payment_channel
varchar(64) third_party_no
tinyint status
datetime payment_time
datetime create_time
}
```

**Diagram sources**
- [Order.java](file://backend/order-service/src/main/java/com/mall/order/entity/Order.java)
- [OrderItem.java](file://backend/order-service/src/main/java/com/mall/order/entity/OrderItem.java)
- [数据字典.md](file://数据字典.md)