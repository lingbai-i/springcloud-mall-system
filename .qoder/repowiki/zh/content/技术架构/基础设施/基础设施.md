# 基础设施

<cite>
**本文档引用文件**  
- [docker-compose.yml](file://docker-compose.yml)
- [docker-compose-dev.yml](file://docker-compose-dev.yml)
- [prometheus.yml](file://config/prometheus.yml)
- [MinioConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/MinioConfig.java)
- [FileUploadService.java](file://backend/merchant-service/src/main/java/com/mall/merchant/service/FileUploadService.java)
- [UserController.java](file://backend/user-service/src/main/java/com/mall/user/controller/UserController.java)
- [MinioConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/MinioConfig.java)
- [Dockerfile](file://backend/admin-service/Dockerfile)
- [Dockerfile](file://backend/order-service/Dockerfile)
- [application-docker.yml](file://backend/user-service/src/main/resources/application-docker.yml)
- [application-docker.yml](file://backend/merchant-service/src/main/resources/application-docker.yml)
</cite>

## 目录
1. [引言](#引言)
2. [容器化部署方案](#容器化部署方案)
3. [Docker Compose 编排配置](#docker-compose-编排配置)
4. [Prometheus 监控系统配置](#prometheus-监控系统配置)
5. [MinIO 对象存储集成](#minio-对象存储集成)
6. [基础设施部署拓扑](#基础设施部署拓扑)
7. [总结](#总结)

## 引言
本文档详细阐述了 `springcloud-mall` 项目的基础设施部署与运维支撑体系。重点介绍基于 Docker 的容器化部署策略、使用 docker-compose 的服务编排、Prometheus 监控系统的指标采集机制，以及 MinIO 对象存储的集成方式。通过本指南，运维人员可快速掌握系统的部署流程、监控配置和核心组件的运行机制。

## 容器化部署方案

本项目采用 Docker 容器化技术进行部署，所有后端微服务均基于 OpenJDK 17 构建，确保运行环境的一致性。Dockerfile 作为构建镜像的基础，定义了服务的运行时环境和启动命令。

### Dockerfile 构建策略
项目中的微服务（如 `admin-service` 和 `order-service`）均包含独立的 Dockerfile。其构建策略遵循以下标准：
1.  **基础镜像**：使用 `openjdk:17-jdk-slim` 作为基础镜像，该镜像轻量且专为 Java 应用优化。
2.  **工作目录**：在容器内创建 `/app` 目录作为工作空间。
3.  **应用复制**：将 Maven 构建生成的 JAR 包（位于 `target/` 目录下）复制到容器的 `/app` 目录中。
4.  **端口暴露**：通过 `EXPOSE` 指令声明服务监听的端口（如 admin-service 为 8081，order-service 为 8083）。
5.  **环境变量**：使用 `ENV` 指令设置 JVM 启动参数（`JAVA_OPTS`），限制堆内存大小以优化资源使用。
6.  **启动命令**：通过 `ENTRYPOINT` 指令定义容器启动时执行的命令，即使用 `java -jar` 运行 JAR 包。
7.  **健康检查**：集成 `HEALTHCHECK` 指令，定期调用 Spring Boot Actuator 的 `/actuator/health` 端点来检测服务的健康状态，确保容器编排系统能准确判断服务可用性。

此标准化的构建策略保证了所有服务镜像的一致性和可靠性。

**Section sources**
- [Dockerfile](file://backend/admin-service/Dockerfile#L1-L15)
- [Dockerfile](file://backend/order-service/Dockerfile#L1-L15)

## Docker Compose 编排配置

`docker-compose.yml` 文件是整个系统基础设施的编排蓝图，它定义了所有服务、网络和数据卷的配置，实现了“一键部署”整个微服务生态。

### 核心服务配置
编排文件中定义了以下关键基础设施服务：

-   **MySQL (mysql)**：使用 `mysql:8.0` 镜像，容器名为 `mall-mysql`。通过环境变量设置 root 密码，并将宿主机的 `3307` 端口映射到容器的 `3306` 端口。数据通过 `mysql_data` 卷进行持久化存储，并在启动时自动执行 `./sql` 目录下的初始化脚本。
-   **Redis (redis)**：使用 `redis:7-alpine` 镜像，容器名为 `mall-redis`。通过 `redis_data` 卷持久化数据，并配置 `appendonly yes` 以增强数据安全性。
-   **Nacos (nacos)**：使用 `nacos/nacos-server:v2.3.0` 镜像，作为服务注册与配置中心。配置其连接到上述 MySQL 实例以持久化配置数据，并将管理端口 `8848` 和 `9848` 映射到宿主机。
-   **MinIO (minio)**：使用 `minio/minio:latest` 镜像，作为对象存储服务。通过 `minio_data` 卷持久化存储，暴露 `9000` (API) 和 `9001` (Web 控制台) 端口。通过环境变量设置管理员账户和密码。
-   **Prometheus (prometheus)**：使用 `prom/prometheus:latest` 镜像，用于指标监控。通过 `./config/prometheus.yml` 文件挂载自定义配置，并将 `9090` 端口映射到宿主机。
-   **Grafana (grafana)**：使用 `grafana/grafana:latest` 镜像，用于可视化监控数据。通过 `grafana_data` 卷持久化仪表盘配置，并将 `3000` 端口映射到宿主机的 `3001` 端口。

### 微服务与前端配置
-   **微服务**：如 `user-service`, `order-service` 等，均使用 `eclipse-temurin:17-jre` 作为基础镜像。它们通过 `volumes` 将宿主机上构建好的 JAR 包挂载到容器内，并通过 `command` 指令启动。这些服务通过 `depends_on` 依赖于 `mysql`, `nacos`, `redis` 等基础设施，确保依赖服务先启动。它们的 Spring Boot 配置文件通过环境变量（如 `SPRING_PROFILES_ACTIVE=docker`）指定为 `docker` 模式。
-   **前端 (frontend)**：使用 `node:18-alpine` 镜像，将前端代码目录挂载到容器内，并执行 `npm run dev -- --host 0.0.0.0` 命令启动 Vite 开发服务器，使其可被外部访问。

### 网络与数据卷
所有服务均连接到名为 `mall-network` 的自定义桥接网络，确保服务间可通过服务名进行通信。所有需要持久化的数据（如数据库、Redis、MinIO 存储、日志等）都通过命名数据卷（volumes）进行管理，保证数据在容器重启后不丢失。

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L485)

### 开发环境专用编排
项目还提供了 `docker-compose-dev.yml` 文件，专为本地开发设计。它仅包含 MySQL、Redis 和 Nacos 三个核心基础设施，不包含任何业务微服务。这使得开发人员可以快速启动一个轻量级的本地环境，专注于单个服务的开发和调试。

**Section sources**
- [docker-compose-dev.yml](file://docker-compose-dev.yml#L1-L92)

## Prometheus 监控系统配置

Prometheus 是系统的核心监控组件，负责从各个服务采集指标数据。其配置文件 `prometheus.yml` 定义了数据抓取（scrape）的目标和规则。

### 指标采集配置
`prometheus.yml` 文件中的 `scrape_configs` 部分定义了多个抓取任务：

-   **Prometheus 自身** (`job_name: 'prometheus'`)：监控 Prometheus 服务器自身的运行状态。
-   **Spring Boot 应用** (`job_name: 'spring-boot-apps'`)：这是最重要的监控任务。它通过 `/actuator/prometheus` 端点从所有 Spring Boot 微服务（如网关、用户服务、商品服务等）采集指标。目标地址使用 `host.docker.internal`，这是 Docker Desktop 中宿主机的特殊 DNS 名称，允许容器内的 Prometheus 访问宿主机上运行的微服务。
-   **MySQL** (`job_name: 'mysql'`)：通过 `mysql-exporter` 组件（需单独部署）采集 MySQL 数据库的性能指标。
-   **Redis** (`job_name: 'redis'`)：通过 `redis_exporter` 组件采集 Redis 的内存、连接数等指标。
-   **Elasticsearch** (`job_name: 'elasticsearch'`)：采集 Elasticsearch 集群的健康状态和性能数据。
-   **Node Exporter** (`job_name: 'node'`)：采集宿主机的系统级指标，如 CPU、内存、磁盘 I/O 等。

### 采集的指标类型
通过 Spring Boot Actuator 的 `micrometer` 集成，Prometheus 可以采集到丰富的指标：
-   **JVM 指标**：如 `jvm_memory_used`, `jvm_threads_live`, `jvm_gc_pause_seconds` 等，用于监控应用的内存使用、线程状态和垃圾回收情况。
-   **HTTP 接口指标**：如 `http_server_requests_seconds_count` 和 `http_server_requests_seconds_max`，用于监控每个 HTTP 接口的请求量、响应时间和错误率。
-   **自定义业务指标**：开发人员可以在代码中定义自定义指标（如订单创建速率、支付成功率），并通过 Actuator 暴露给 Prometheus。

**Section sources**
- [prometheus.yml](file://config/prometheus.yml#L1-L45)

## MinIO 对象存储集成

MinIO 被用作系统的对象存储服务，用于存放用户头像、商家入驻资料、商品图片等非结构化文件。

### 集成方式
1.  **依赖引入**：在 `merchant-service` 的 `pom.xml` 中引入了 `io.minio:minio` 依赖。
2.  **配置类**：在 `user-service` 和 `merchant-service` 中均定义了 `MinioConfig` 类。该类使用 `@Value` 注解注入 MinIO 的 `endpoint`、`access-key` 和 `secret-key` 等配置，并通过 `@Bean` 注解创建一个全局的 `MinioClient` 实例，供服务内部使用。
3.  **存储桶初始化**：`user-service` 的 `MinioConfig` 类在初始化 `MinioClient` 后，会检查配置的存储桶（bucket）是否存在。如果不存在，则会自动创建该存储桶，并设置其访问策略为“公开读”（public-read），以便前端可以直接通过 URL 访问图片资源。

### 文件上传下载流程
以用户上传头像为例，其流程如下：
1.  **前端请求**：用户通过前端界面选择头像文件并发起上传请求。
2.  **后端接收**：`user-service` 的 `UserController` 接收 `POST /upload-avatar` 请求，获取 `MultipartFile` 对象。
3.  **文件验证**：服务端对文件进行校验，包括非空检查、文件类型（必须为图片）和文件大小（不超过 2MB）。
4.  **上传至 MinIO**：调用 `MinioService` 的 `uploadAvatar` 方法。该方法使用 `MinioClient.putObject()` API 将文件流上传到指定的存储桶中。文件名通常包含时间戳和随机数以保证唯一性。
5.  **生成访问 URL**：文件上传成功后，服务端根据 MinIO 的访问地址、存储桶名和文件名，拼接出一个可公开访问的 URL。
6.  **更新数据库**：将生成的头像 URL 保存到用户信息表中。
7.  **返回结果**：将头像 URL 返回给前端，前端即可使用该 URL 显示用户头像。

商家上传商品图片的流程类似，由 `merchant-service` 的 `FileUploadService` 提供支持。

**Section sources**
- [MinioConfig.java](file://backend/user-service/src/main/java/com/mall/user/config/MinioConfig.java#L11-L90)
- [MinioConfig.java](file://backend/merchant-service/src/main/java/com/mall/merchant/config/MinioConfig.java#L7-L32)
- [FileUploadService.java](file://backend/merchant-service/src/main/java/com/mall/merchant/service/FileUploadService.java#L16-L141)
- [UserController.java](file://backend/user-service/src/main/java/com/mall/user/controller/UserController.java#L722-L782)

## 基础设施部署拓扑

```mermaid
graph TD
subgraph "基础设施层"
MySQL[(MySQL 8.0)]
Redis[(Redis 7)]
Nacos[(Nacos)]
MinIO[(MinIO)]
Prometheus[(Prometheus)]
Grafana[(Grafana)]
end
subgraph "微服务层"
Gateway[(网关服务)]
UserService[(用户服务)]
ProductService[(商品服务)]
OrderService[(订单服务)]
MerchantService[(商家服务)]
PaymentService[(支付服务)]
AdminService[(管理服务)]
end
subgraph "前端层"
Frontend[(前端 Vite)]
end
MySQL < --> |JDBC| UserService
MySQL < --> |JDBC| ProductService
MySQL < --> |JDBC| OrderService
MySQL < --> |JDBC| MerchantService
MySQL < --> |JDBC| PaymentService
MySQL < --> |JDBC| AdminService
Redis < --> |Jedis| UserService
Redis < --> |Jedis| ProductService
Redis < --> |Jedis| OrderService
Redis < --> |Jedis| MerchantService
Redis < --> |Jedis| PaymentService
Redis < --> |Jedis| AdminService
Nacos < --> |服务注册/发现| Gateway
Nacos < --> |服务注册/发现| UserService
Nacos < --> |服务注册/发现| ProductService
Nacos < --> |服务注册/发现| OrderService
Nacos < --> |服务注册/发现| MerchantService
Nacos < --> |服务注册/发现| PaymentService
Nacos < --> |服务注册/发现| AdminService
MinIO < --> |S3 API| UserService
MinIO < --> |S3 API| MerchantService
Gateway < --> |HTTP| Frontend
Gateway < --> |HTTP| UserService
Gateway < --> |HTTP| ProductService
Gateway < --> |HTTP| OrderService
Gateway < --> |HTTP| MerchantService
Gateway < --> |HTTP| PaymentService
Gateway < --> |HTTP| AdminService
Prometheus < --> |HTTP| Gateway
Prometheus < --> |HTTP| UserService
Prometheus < --> |HTTP| ProductService
Prometheus < --> |HTTP| OrderService
Prometheus < --> |HTTP| PaymentService
Prometheus < --> |HTTP| MySQL
Prometheus < --> |HTTP| Redis
Grafana < --> |数据查询| Prometheus
style MySQL fill:#f9f,stroke:#333
style Redis fill:#f9f,stroke:#333
style Nacos fill:#f9f,stroke:#333
style MinIO fill:#f9f,stroke:#333
style Prometheus fill:#f9f,stroke:#333
style Grafana fill:#f9f,stroke:#333
style Gateway fill:#bbf,stroke:#333
style UserService fill:#bbf,stroke:#333
style ProductService fill:#bbf,stroke:#333
style OrderService fill:#bbf,stroke:#333
style MerchantService fill:#bbf,stroke:#333
style PaymentService fill:#bbf,stroke:#333
style AdminService fill:#bbf,stroke:#333
style Frontend fill:#bbf,stroke:#333
```

**Diagram sources**
- [docker-compose.yml](file://docker-compose.yml#L9-L485)
- [prometheus.yml](file://config/prometheus.yml#L1-L45)

## 总结
`springcloud-mall` 项目构建了一套完整的、基于容器化的基础设施体系。通过 `docker-compose` 实现了从数据库、缓存、注册中心到微服务和前端的自动化编排部署。Prometheus 与 Grafana 的集成提供了强大的监控和可视化能力，确保系统稳定运行。MinIO 的引入则高效地解决了文件存储和访问的问题。这套方案为系统的可维护性、可扩展性和高可用性奠定了坚实的基础。