# 环境管理

<cite>
**本文档引用的文件**   
- [docker-compose.yml](file://docker-compose.yml)
- [docker-compose-dev.yml](file://docker-compose-dev.yml)
- [application-docker.yml](file://backend/admin-service/src/main/resources/application-docker.yml)
- [application-simple.yml](file://backend/gateway-service/src/main/resources/application-simple.yml)
- [application-docker.yml](file://backend/user-service/src/main/resources/application-docker.yml)
- [application-docker.yml](file://backend/merchant-service/src/main/resources/application-docker.yml)
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md)
</cite>

## 目录
1. [多环境配置策略](#多环境配置策略)
2. [Docker生产环境编排](#docker生产环境编排)
3. [开发环境轻量级启动](#开发环境轻量级启动)
4. [微服务环境差异化配置](#微服务环境差异化配置)
5. [环境切换最佳实践](#环境切换最佳实践)
6. [配置冲突解决方案](#配置冲突解决方案)

## 多环境配置策略

本项目采用Spring Profiles机制实现多环境配置管理，通过`SPRING_PROFILES_ACTIVE`环境变量控制不同环境下的配置加载。核心配置文件包括：
- `application.yml`：基础通用配置
- `application-docker.yml`：Docker生产环境专用配置
- `application-simple.yml`：简化开发环境配置

配置优先级遵循Spring Boot规则：`application-{profile}.yml` > `application.yml`，当激活特定profile时，对应配置文件中的属性会覆盖基础配置。

**Section sources**
- [application-docker.yml](file://backend/admin-service/src/main/resources/application-docker.yml)
- [application-simple.yml](file://backend/gateway-service/src/main/resources/application-simple.yml)
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md#L340-L348)

## Docker生产环境编排

通过`docker-compose.yml`文件实现生产环境的完整基础设施与服务编排，包含完整的微服务生态系统。

```mermaid
graph TD
subgraph "基础设施服务"
MySQL[(MySQL)]
Redis[(Redis)]
Nacos[(Nacos)]
RocketMQ[(RocketMQ)]
MinIO[(MinIO)]
Prometheus[(Prometheus)]
Grafana[(Grafana)]
end
subgraph "微服务应用"
Gateway[网关服务]
User[用户服务]
Product[商品服务]
Cart[购物车服务]
Order[订单服务]
Payment[支付服务]
Merchant[商家服务]
Admin[管理服务]
SMS[短信服务]
end
MySQL --> Nacos
Redis --> Nacos
MySQL --> User
Redis --> User
MySQL --> Product
Redis --> Product
MySQL --> Cart
Redis --> Cart
MySQL --> Order
Redis --> Order
RabbitMQ --> Order
MySQL --> Payment
Redis --> Payment
MySQL --> Merchant
Redis --> Merchant
MySQL --> Admin
Redis --> Admin
MySQL --> SMS
Redis --> SMS
Nacos --> Gateway
Nacos --> User
Nacos --> Product
Nacos --> Cart
Nacos --> Order
Nacos --> Payment
Nacos --> Merchant
Nacos --> Admin
Nacos --> SMS
Gateway --> User
Gateway --> Product
Gateway --> Cart
Gateway --> Order
Gateway --> Payment
Gateway --> Merchant
Gateway --> Admin
Gateway --> SMS
```

**Diagram sources **
- [docker-compose.yml](file://docker-compose.yml#L9-L452)

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L1-L485)

## 开发环境轻量级启动

通过`docker-compose-dev.yml`实现开发环境的轻量级基础设施启动，仅包含核心依赖服务。

```mermaid
graph TD
MySQL[(MySQL)]
Redis[(Redis)]
Nacos[(Nacos)]
MySQL --> Nacos
Redis --> Nacos
subgraph "健康检查"
MySQL --> HC1["健康检查: mysqladmin ping"]
Redis --> HC2["健康检查: redis-cli ping"]
Nacos --> HC3["健康检查: curl /nacos/actuator/health"]
end
subgraph "启动依赖"
MySQL -.-> Nacos
Nacos -.-> "其他微服务"
end
```

**Diagram sources **
- [docker-compose-dev.yml](file://docker-compose-dev.yml#L8-L78)

**Section sources**
- [docker-compose-dev.yml](file://docker-compose-dev.yml#L1-L92)

## 微服务环境差异化配置

各微服务通过`SPRING_PROFILES_ACTIVE`环境变量加载对应的配置文件，实现环境差异化配置。

### 数据库连接配置

```mermaid
classDiagram
class DatabaseConfig {
<<配置类>>
+String url
+String username
+String password
+String driverClassName
}
class DockerConfig {
<<Docker环境>>
+url : jdbc : mysql : //mysql : 3306/dbname
+host : mysql
}
class SimpleConfig {
<<开发环境>>
+url : jdbc : mysql : //localhost : 3306/dbname
+host : localhost
}
DatabaseConfig <|-- DockerConfig
DatabaseConfig <|-- SimpleConfig
```

**Diagram sources **
- [application-docker.yml](file://backend/user-service/src/main/resources/application-docker.yml#L3-L7)
- [application-simple.yml](file://backend/gateway-service/src/main/resources/application-simple.yml#L5-L9)

### 注册中心与Redis配置

微服务在不同环境下的注册中心和Redis配置差异：

| 配置项 | Docker环境 | 开发环境 |
|--------|------------|----------|
| **Nacos地址** | nacos:8848 | localhost:8848 |
| **Nacos命名空间** | docker | simple |
| **Redis主机** | redis | localhost |
| **Redis端口** | 6379 | 6379 |
| **Redis数据库** | 0-2 | 0-2 |

**Section sources**
- [application-docker.yml](file://backend/merchant-service/src/main/resources/application-docker.yml#L40-L45)
- [application-simple.yml](file://backend/gateway-service/src/main/resources/application-simple.yml#L7-L13)

## 环境切换最佳实践

### 配置文件优先级

遵循Spring Boot的配置优先级规则，确保环境特定配置能够正确覆盖通用配置。

```mermaid
flowchart TD
A["加载 application.yml"] --> B["加载 application-{profile}.yml"]
B --> C["profile配置覆盖通用配置"]
C --> D["最终生效配置"]
style A fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#f96,stroke:#333
style D fill:#9f9,stroke:#333
```

**Diagram sources **
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md#L340-L348)

### 环境变量覆盖规则

环境变量的优先级高于配置文件，可通过Docker环境变量实现配置覆盖：

1. 命令行参数（最高优先级）
2. 系统环境变量
3. 配置文件中的环境变量
4. application-{profile}.yml
5. application.yml（最低优先级）

**Section sources**
- [docker-compose.yml](file://docker-compose.yml#L242-L248)
- [docker-compose.yml](file://docker-compose.yml#L270-L279)

## 配置冲突解决方案

### Nacos命名空间不匹配问题

当服务注册与发现的命名空间不一致时会导致服务无法发现，解决方案：

```mermaid
sequenceDiagram
participant Gateway as 网关服务
participant Nacos as Nacos注册中心
participant Merchant as 商家服务
Merchant->>Nacos : 注册到simple命名空间
Gateway->>Nacos : 在public命名空间查找
Nacos-->>Gateway : 未找到服务
Gateway->>Nacos : 在simple命名空间查找
Nacos-->>Gateway : 返回服务实例
Gateway->>Merchant : 转发请求
Note over Nacos : 统一命名空间为simple
```

**Diagram sources **
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md#L98-L107)

### StripPrefix配置错误

路由前缀剥离配置错误会导致路径不匹配，正确配置应确保路径转换正确：

```mermaid
flowchart LR
A["请求: /api/merchants/apply"] --> B["StripPrefix=1"]
B --> C["转发: /merchants/apply"]
C --> D["商家服务Controller匹配成功"]
E["请求: /api/merchants/apply"] --> F["StripPrefix=2"]
F --> G["转发: /apply"]
G --> H["商家服务Controller匹配失败"]
style C fill:#9f9,stroke:#333
style G fill:#f99,stroke:#333
```

**Diagram sources **
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md#L118-L124)

**Section sources**
- [商家入驻404问题-根本修复完成.md](file://商家入驻404问题-根本修复完成.md#L55-L73)
- [application-simple.yml](file://backend/gateway-service/src/main/resources/application-simple.yml#L102-L107)