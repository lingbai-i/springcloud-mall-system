# 状态管理

<cite>
**本文档引用文件**   
- [user.js](file://frontend/src/stores/user.js)
- [cart.js](file://frontend/src/stores/cart.js)
- [main.js](file://frontend/src/main.js)
- [index.js](file://frontend/src/router/index.js)
- [request.js](file://frontend/src/utils/request.js)
- [auth.js](file://frontend/src/api/auth.js)
- [user.js](file://frontend/src/api/user.js)
- [cart.js](file://frontend/src/api/cart.js)
- [CartSyncServiceImpl.java](file://backend/cart-service/src/main/java/com/mall/cart/service/impl/CartSyncServiceImpl.java)
- [CartSyncTask.java](file://backend/cart-service/src/main/java/com/mall/cart/task/CartSyncTask.java)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [用户状态管理](#用户状态管理)
4. [购物车状态管理](#购物车状态管理)
5. [状态持久化配置](#状态持久化配置)
6. [状态管理与API调用协同](#状态管理与api调用协同)
7. [状态管理与路由守卫协同](#状态管理与路由守卫协同)
8. [最佳实践](#最佳实践)

## 项目结构

```mermaid
graph TD
A[前端] --> B[src]
B --> C[stores]
C --> D[user.js]
C --> E[cart.js]
B --> F[main.js]
B --> G[router]
G --> H[index.js]
B --> I[utils]
I --> J[request.js]
B --> K[api]
K --> L[auth.js]
K --> M[user.js]
K --> N[cart.js]
O[后端] --> P[cart-service]
P --> Q[service]
Q --> R[CartSyncServiceImpl.java]
P --> S[task]
S --> T[CartSyncTask.java]
```

**Diagram sources**
- [user.js](file://frontend/src/stores/user.js)
- [cart.js](file://frontend/src/stores/cart.js)
- [main.js](file://frontend/src/main.js)
- [index.js](file://frontend/src/router/index.js)
- [CartSyncServiceImpl.java](file://backend/cart-service/src/main/java/com/mall/cart/service/impl/CartSyncServiceImpl.java)
- [CartSyncTask.java](file://backend/cart-service/src/main/java/com/mall/cart/task/CartSyncTask.java)

**Section sources**
- [user.js](file://frontend/src/stores/user.js)
- [cart.js](file://frontend/src/stores/cart.js)
- [main.js](file://frontend/src/main.js)
- [index.js](file://frontend/src/router/index.js)
- [CartSyncServiceImpl.java](file://backend/cart-service/src/main/java/com/mall/cart/service/impl/CartSyncServiceImpl.java)
- [CartSyncTask.java](file://backend/cart-service/src/main/java/com/mall/cart/task/CartSyncTask.java)

## 核心组件

前端状态管理基于Pinia实现，主要包含用户状态管理(userStore)和购物车状态管理(cartStore)两个核心模块。通过Pinia插件实现状态持久化，并与API调用、路由守卫等系统组件协同工作。

**Section sources**
- [user.js](file://frontend/src/stores/user.js)
- [cart.js](file://frontend/src/stores/cart.js)

## 用户状态管理

用户状态管理模块(useUserStore)负责管理用户登录状态和用户信息。包含以下核心要素：

- **状态**：token、userInfo
- **计算属性**：isLoggedIn、username、avatar、userId、merchantId、isAdmin、isMerchant
- **方法**：login、userRegister、logout、userLogout、updateUserInfo、fetchUserInfo、initUserState

其中，isAdmin和isMerchant计算属性通过多种条件判断用户角色，确保权限判断的准确性。

```mermaid
classDiagram
class useUserStore {
+token : ref
+userInfo : ref
+isLoggedIn : computed
+username : computed
+avatar : computed
+userId : computed
+merchantId : computed
+isAdmin : computed
+isMerchant : computed
+login(loginData) : Promise
+userRegister(registerData) : Promise
+logout() : void
+userLogout() : void
+updateUserInfo(newUserInfo) : void
+fetchUserInfo() : Promise
+initUserState() : void
}
```

**Diagram sources**
- [user.js](file://frontend/src/stores/user.js#L15-L258)

**Section sources**
- [user.js](file://frontend/src/stores/user.js#L15-L258)

## 购物车状态管理

购物车状态管理模块(useCartStore)负责管理购物车相关状态和操作。包含以下核心要素：

- **状态**：cartItems、loading
- **计算属性**：totalCount、totalPrice
- **方法**：fetchCartItems、addToCart、updateQuantity、removeFromCart、toggleSelect、clearCart

该模块通过API调用与后端购物车服务进行数据同步，确保前后端数据一致性。

```mermaid
classDiagram
class useCartStore {
+cartItems : ref
+loading : ref
+totalCount : computed
+totalPrice : computed
+fetchCartItems() : Promise
+addToCart(productId, quantity, specifications) : Promise
+updateQuantity(productId, quantity) : Promise
+removeFromCart(productId) : Promise
+toggleSelect(productId, selected) : Promise
+clearCart() : Promise
}
```

**Diagram sources**
- [cart.js](file://frontend/src/stores/cart.js#L5-L127)

**Section sources**
- [cart.js](file://frontend/src/stores/cart.js#L5-L127)

## 状态持久化配置

状态持久化通过pinia-plugin-persistedstate插件实现。在main.js中进行配置：

1. 引入pinia-plugin-persistedstate插件
2. 将插件添加到Pinia实例
3. 在store定义中配置持久化选项

userStore的持久化配置指定将token和userInfo状态持久化到localStorage中，确保页面刷新后用户状态不丢失。

```mermaid
sequenceDiagram
participant App as 应用入口
participant Pinia as Pinia实例
participant Plugin as 持久化插件
participant Store as 用户状态Store
participant Storage as localStorage
App->>Pinia : createPinia()
Pinia->>Plugin : pinia.use(plugin)
Plugin->>Store : 监听状态变化
Store->>Storage : 序列化并存储状态
Storage->>Store : 页面加载时恢复状态
```

**Diagram sources**
- [main.js](file://frontend/src/main.js#L28-L30)
- [user.js](file://frontend/src/stores/user.js#L253-L257)

**Section sources**
- [main.js](file://frontend/src/main.js#L28-L30)
- [user.js](file://frontend/src/stores/user.js#L253-L257)

## 状态管理与API调用协同

状态管理与API调用通过请求拦截器和响应处理机制协同工作：

1. 请求拦截器自动添加认证头
2. 响应拦截器统一处理认证过期
3. 状态管理模块调用API并更新状态

当token过期时，请求拦截器会触发重新登录流程，确保用户体验的连续性。

```mermaid
sequenceDiagram
participant Store as 状态管理
participant API as API调用
participant Interceptor as 请求拦截器
participant Server as 后端服务
Store->>API : 调用API方法
API->>Interceptor : 发起请求
Interceptor->>Interceptor : 添加Authorization头
Interceptor->>Server : 发送请求
Server->>Interceptor : 返回401
Interceptor->>Store : 触发登录过期处理
Store->>Store : 清除状态并重定向
```

**Diagram sources**
- [user.js](file://frontend/src/stores/user.js)
- [request.js](file://frontend/src/utils/request.js)
- [auth.js](file://frontend/src/api/auth.js)

**Section sources**
- [user.js](file://frontend/src/stores/user.js)
- [request.js](file://frontend/src/utils/request.js)
- [auth.js](file://frontend/src/api/auth.js)

## 状态管理与路由守卫协同

状态管理与路由守卫通过全局前置守卫实现权限控制：

1. 检查路由是否需要认证
2. 验证用户登录状态
3. 检查管理员或商家权限
4. 处理已登录用户的登录页面访问

路由守卫根据用户角色和权限进行重定向，确保用户只能访问授权的页面。

```mermaid
flowchart TD
A[路由跳转] --> B{需要认证?}
B --> |是| C{已登录?}
B --> |否| D[允许访问]
C --> |是| E{需要管理员权限?}
C --> |否| F[重定向到登录页]
E --> |是| G{是管理员?}
E --> |否| H{需要商家权限?}
G --> |是| I[允许访问]
G --> |否| J[显示无权限]
H --> |是| K{是商家?}
H --> |否| L[允许访问]
K --> |是| M[允许访问]
K --> |否| N[显示无权限]
```

**Diagram sources**
- [index.js](file://frontend/src/router/index.js#L571-L642)
- [user.js](file://frontend/src/stores/user.js)

**Section sources**
- [index.js](file://frontend/src/router/index.js#L571-L642)
- [user.js](file://frontend/src/stores/user.js)

## 最佳实践

### 模块划分
- 按功能划分store模块
- 用户相关状态放在userStore
- 购物车相关状态放在cartStore
- 避免单一store过于臃肿

### 错误处理
- API调用使用try-catch捕获异常
- 统一错误提示机制
- 记录关键操作日志
- 提供用户友好的错误信息

### 调试技巧
- 开发环境输出状态变化日志
- 使用Vue DevTools进行状态调试
- 关键操作添加console.log
- 实现initUserState用于状态初始化调试

### 后端同步机制
后端购物车服务通过定时任务实现数据同步：

1. 每小时清理过期数据
2. 每6小时检查数据一致性
3. 每天批量刷新过期时间

```mermaid
sequenceDiagram
participant Task as 定时任务
participant Service as 同步服务
participant Redis as Redis存储
loop 每小时
Task->>Service : cleanExpiredCartData
Service->>Redis : 清理过期数据
end
loop 每6小时
Task->>Service : checkCartDataConsistency
Service->>Redis : 检查数据一致性
Service->>Redis : 修复不一致数据
end
loop 每天
Task->>Service : batchRefreshCartExpireTime
Service->>Redis : 批量刷新过期时间
end
```

**Diagram sources**
- [CartSyncTask.java](file://backend/cart-service/src/main/java/com/mall/cart/task/CartSyncTask.java)
- [CartSyncServiceImpl.java](file://backend/cart-service/src/main/java/com/mall/cart/service/impl/CartSyncServiceImpl.java)

**Section sources**
- [CartSyncTask.java](file://backend/cart-service/src/main/java/com/mall/cart/task/CartSyncTask.java)
- [CartSyncServiceImpl.java](file://backend/cart-service/src/main/java/com/mall/cart/service/impl/CartSyncServiceImpl.java)