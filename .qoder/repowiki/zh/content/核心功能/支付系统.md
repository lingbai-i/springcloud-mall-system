# 支付系统

<cite>
**本文档引用的文件**   
- [PaymentController.java](file://backend\payment-service\src\main\java\com\mall\payment\controller\PaymentController.java)
- [PaymentCallbackController.java](file://backend\payment-service\src\main\java\com\mall\payment\controller\PaymentCallbackController.java)
- [PaymentService.java](file://backend\payment-service\src\main\java\com\mall\payment\service\PaymentService.java)
- [PaymentServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentServiceImpl.java)
- [PaymentChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentChannelServiceImpl.java)
- [RefundServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\RefundServiceImpl.java)
- [RefundChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\RefundChannelServiceImpl.java)
- [PaymentOrder.java](file://backend\payment-service\src\main\java\com\mall\payment\entity\PaymentOrder.java)
- [RefundOrder.java](file://backend\payment-service\src\main\java\com\mall\payment\entity\RefundOrder.java)
- [PaymentStatus.java](file://backend\payment-service\src\main\java\com\mall\payment\enums\PaymentStatus.java)
- [RefundStatus.java](file://backend\payment-service\src\main\java\com\mall\payment\enums\RefundStatus.java)
- [PaymentCreateRequest.java](file://backend\payment-service\src\main\java\com\mall\payment\dto\request\PaymentCreateRequest.java)
- [RefundCreateRequest.java](file://backend\payment-service\src\main\java\com\mall\payment\dto\request\RefundCreateRequest.java)
- [index.vue](file://frontend\src\views\checkout\index.vue)
- [order.js](file://frontend\src\api\order.js)
</cite>

## 目录
1. [支付系统](#支付系统)
2. [核心组件](#核心组件)
3. [支付创建流程](#支付创建流程)
4. [支付状态机](#支付状态机)
5. [支付回调处理](#支付回调处理)
6. [退款处理机制](#退款处理机制)
7. [前端支付集成](#前端支付集成)
8. [安全防护措施](#安全防护措施)

## 核心组件

支付系统由多个核心组件构成，包括支付控制器、支付服务、支付渠道服务、退款服务等。`PaymentController`负责接收支付请求并调用`PaymentService`进行业务处理，`PaymentChannelService`负责与第三方支付平台的交互，`PaymentCallbackController`处理来自第三方平台的异步通知。

**Section sources**
- [PaymentController.java](file://backend\payment-service\src\main\java\com\mall\payment\controller\PaymentController.java#L57-L526)
- [PaymentService.java](file://backend\payment-service\src\main\java\com\mall\payment\service\PaymentService.java#L40-L278)
- [PaymentChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentChannelServiceImpl.java#L63-L1157)

## 支付创建流程

支付创建流程始于前端结算页调用支付接口，`PaymentController`接收`PaymentCreateRequest`请求，验证参数后调用`PaymentService.createPaymentOrder()`方法创建支付订单。系统支持多种支付方式，包括微信、支付宝、银行卡和余额支付，通过`PaymentMethod`枚举统一管理。

```mermaid
sequenceDiagram
participant Frontend as 前端
participant PaymentController as PaymentController
participant PaymentService as PaymentService
participant PaymentChannelService as PaymentChannelService
Frontend->>PaymentController : POST /api/payment/orders
PaymentController->>PaymentService : createPaymentOrder(request)
PaymentService->>PaymentService : 验证参数、风控检查
PaymentService->>PaymentService : 创建支付订单
PaymentService->>PaymentChannelService : initiatePayment(paymentOrder)
PaymentChannelService->>PaymentChannelService : 调用第三方支付接口
PaymentChannelService-->>PaymentService : 支付信息
PaymentService-->>PaymentController : 支付订单响应
PaymentController-->>Frontend : 返回支付订单详情
```

**Diagram sources**
- [PaymentController.java](file://backend\payment-service\src\main\java\com\mall\payment\controller\PaymentController.java#L93-L117)
- [PaymentService.java](file://backend\payment-service\src\main\java\com\mall\payment\service\PaymentService.java#L60-L65)
- [PaymentChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentChannelServiceImpl.java#L89-L110)

## 支付状态机

支付状态机定义了支付订单的完整生命周期，从创建到最终状态的流转过程。状态包括待支付、支付中、支付成功、支付失败、已取消、已过期、已退款和部分退款。状态流转受到严格控制，确保数据一致性。

```mermaid
stateDiagram-v2
[*] --> PENDING
PENDING --> PROCESSING : 发起支付
PROCESSING --> SUCCESS : 支付成功
PROCESSING --> FAILED : 支付失败
PROCESSING --> CANCELLED : 取消支付
PENDING --> CANCELLED : 取消订单
PENDING --> EXPIRED : 订单过期
SUCCESS --> REFUNDED : 全额退款
SUCCESS --> PARTIAL_REFUNDED : 部分退款
PARTIAL_REFUNDED --> REFUNDED : 再次全额退款
FAILED --> PENDING : 重试支付
CANCELLED --> [*]
EXPIRED --> [*]
SUCCESS --> [*]
REFUNDED --> [*]
PARTIAL_REFUNDED --> [*]
```

**Diagram sources**
- [PaymentStatus.java](file://backend\payment-service\src\main\java\com\mall\payment\enums\PaymentStatus.java#L35-L162)
- [PaymentOrder.java](file://backend\payment-service\src\main\java\com\mall\payment\entity\PaymentOrder.java#L108-L110)

## 支付回调处理

支付回调处理是支付系统的关键环节，`PaymentCallbackController`接收来自第三方支付平台的异步通知，验证签名后解析回调数据，更新本地订单状态。系统支持支付宝、微信支付和银行卡支付的回调处理，确保支付状态的最终一致性。

```mermaid
sequenceDiagram
participant ThirdParty as 第三方支付平台
participant PaymentCallbackController as PaymentCallbackController
participant PaymentService as PaymentService
participant PaymentChannelService as PaymentChannelService
ThirdParty->>PaymentCallbackController : POST /api/callback/alipay/payment
PaymentCallbackController->>PaymentChannelService : verifyPaymentCallback()
PaymentChannelService-->>PaymentCallbackController : 签名验证结果
alt 验证失败
PaymentCallbackController-->>ThirdParty : fail
else 验证成功
PaymentCallbackController->>PaymentChannelService : parsePaymentCallback()
PaymentChannelService-->>PaymentCallbackController : 回调信息
PaymentCallbackController->>PaymentService : getPaymentOrderByThirdPartyOrderNo()
PaymentService-->>PaymentCallbackController : 支付订单
alt 支付成功
PaymentCallbackController->>PaymentService : handlePaymentSuccess()
PaymentService-->>PaymentCallbackController : 处理结果
PaymentCallbackController-->>ThirdParty : success
else 支付失败
PaymentCallbackController->>PaymentService : handlePaymentFailure()
PaymentService-->>PaymentCallbackController : 处理结果
PaymentCallbackController-->>ThirdParty : fail
end
end
```

**Diagram sources**
- [PaymentCallbackController.java](file://backend\payment-service\src\main\java\com\mall\payment\controller\PaymentCallbackController.java#L64-L575)
- [PaymentChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentChannelServiceImpl.java#L735-L792)

## 退款处理机制

退款处理机制包括退款申请、审核、处理和状态同步等环节。`RefundServiceImpl`负责处理退款业务逻辑，`RefundChannelService`负责与第三方支付平台的交互。系统支持部分退款和多次退款，通过风控检查和异步处理机制确保退款安全。

```mermaid
sequenceDiagram
participant Frontend as 前端
participant RefundController as RefundController
participant RefundService as RefundService
participant RefundChannelService as RefundChannelService
Frontend->>RefundController : POST /api/refund/orders
RefundController->>RefundService : createRefundOrder(request)
RefundService->>RefundService : 验证参数、风控检查
RefundService->>RefundService : 创建退款订单
RefundService-->>RefundController : 退款订单响应
RefundController-->>Frontend : 返回退款订单详情
Note over RefundService,RefundChannelService : 退款处理异步
RefundService->>RefundChannelService : processRefund()
RefundChannelService-->>RefundService : 退款结果
RefundService->>RefundService : 更新退款订单状态
```

**Diagram sources**
- [RefundServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\RefundServiceImpl.java#L95-L117)
- [RefundChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\RefundChannelServiceImpl.java#L78-L111)

## 前端支付集成

前端在结算页通过`index.vue`组件集成支付功能，用户选择商品和支付方式后，调用支付接口创建支付订单。系统支持轮询支付结果，实时更新订单状态，提供流畅的支付体验。

```mermaid
flowchart TD
A[用户进入结算页] --> B[选择收货地址]
B --> C[确认商品清单]
C --> D[选择支付方式]
D --> E[提交订单]
E --> F[调用支付接口]
F --> G{支付成功?}
G --> |是| H[跳转到订单详情]
G --> |否| I[轮询支付结果]
I --> J{支付完成?}
J --> |是| H
J --> |否| K[继续轮询]
```

**Diagram sources**
- [index.vue](file://frontend\src\views\checkout\index.vue#L1-L662)
- [order.js](file://frontend\src\api\order.js#L71-L78)

## 安全防护措施

支付系统实施了多层次的安全防护措施，包括签名验证、防重放攻击、敏感信息加密等。系统使用分布式锁防止重复支付，通过风控检查识别异常交易，确保支付安全。

```mermaid
flowchart LR
A[请求到达] --> B{是否包含签名?}
B --> |否| C[拒绝请求]
B --> |是| D[验证签名]
D --> E{签名有效?}
E --> |否| C
E --> |是| F[检查时间戳]
F --> G{时间戳在有效期内?}
G --> |否| H[拒绝请求]
G --> |是| I[检查nonce]
I --> J{nonce已使用?}
J --> |是| H
J --> |否| K[处理请求]
K --> L[记录nonce]
```

**Diagram sources**
- [PaymentChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\PaymentChannelServiceImpl.java#L735-L757)
- [RefundChannelServiceImpl.java](file://backend\payment-service\src\main\java\com\mall\payment\service\impl\RefundChannelServiceImpl.java#L149-L174)