# 服务自动检测与管理系统 - 更新日志

## 版本 2.0 (2025-11-11)

### 🎉 重大更新

本次更新为在线商城系统引入了**智能化服务自动检测与管理**功能，大幅提升开发和运维效率。

---

## ✨ 新增功能

### 1. 智能启动脚本 (`start-dev-silent.bat`)

#### 核心特性
- **自动服务发现**: 智能扫描 `backend` 目录，自动识别所有可启动的微服务
- **排除过滤机制**: 自动排除非服务模块（common-bom、common-core、simple-test）
- **依赖关系管理**: 按照预定义的优先级顺序启动服务
- **后台静默运行**: 所有服务在后台运行，无CMD窗口弹出
- **实时状态反馈**: 显示启动进度和服务统计信息
- **完整日志记录**: 所有服务日志统一保存到 `logs/` 目录

#### 改进点
```diff
旧版本:
- 硬编码固定的4个服务
- 新增服务需要手动修改脚本
- 无法适应服务数量变化

新版本:
+ 动态检测所有微服务
+ 新增服务自动识别
+ 灵活适应服务数量变化
+ 智能依赖顺序管理
```

#### 技术实现
```batch
# 动态扫描服务
for /d %%D in ("%BACKEND_DIR%\*") do (
    # 检查 pom.xml 存在性
    # 检查是否在排除列表
    # 自动计数并记录服务
)

# 按配置顺序启动
for %%S in (%SERVICES_CONFIG%) do (
    # 解析配置（服务名:端口:配置文件:延迟）
    # 启动服务到后台
    # 输出日志到文件
)
```

---

### 2. 增强服务状态检查 (`check-services-silent.ps1`)

#### 核心特性
- **自动服务扫描**: 动态检测所有可用的微服务
- **端口自动识别**: 从配置文件读取服务端口
- **实时状态监控**: 检测服务运行状态和健康度
- **日志大小统计**: 显示各服务日志文件大小
- **美观输出格式**: 彩色输出，状态一目了然

#### 改进点
```diff
旧版本:
- 固定的服务列表
- 需手动添加新服务配置

新版本:
+ 自动扫描所有服务
+ 从 application.yml 读取端口
+ 动态服务列表
+ 按端口排序输出
```

#### 输出示例
```
========================================
在线商城服务状态检查
========================================
检查时间: 2025-11-11 14:30:00

Docker 基础设施:
----------------------------------------
  MySQL [运行中] (健康) - 端口 3307
  Redis [运行中] (健康) - 端口 6379
  Nacos [运行中] (健康) - 端口 8848

后端微服务:
----------------------------------------
  Gateway Service [运行中] - 端口 8080 - 日志 2.5 MB
  Auth Service [运行中] - 端口 8081 - 日志 1.8 MB
  User Service [运行中] - 端口 8082 - 日志 1.2 MB
  Product Service [运行中] - 端口 8083 - 日志 980 KB
  Order Service [运行中] - 端口 8084 - 日志 756 KB
  Payment Service [运行中] - 端口 8085 - 日志 654 KB
  Admin Service [运行中] - 端口 8086 - 日志 543 KB
  Merchant Service [运行中] - 端口 8087 - 日志 432 KB
  Cart Service [运行中] - 端口 8088 - 日志 321 KB
  Sms Service [运行中] - 端口 8089 - 日志 210 KB

前端服务:
----------------------------------------
  Frontend [运行中] - 端口 5173 - 日志 1.5 MB

========================================
统计信息
========================================
  运行中: 13 / 13 服务 (100%)

服务访问地址:
  前端应用:    http://localhost:5173
  API网关:     http://localhost:8080
  Nacos控制台: http://localhost:8848/nacos (nacos/nacos)
```

---

### 3. 服务管理工具 (`service-manager.ps1`) 🆕

全新的交互式服务管理工具！

#### 功能特性
- **交互式菜单**: 用户友好的命令行界面
- **服务列表查看**: 显示所有服务及其状态
- **单服务操作**: 启动、停止、重启指定服务
- **日志查看**: 快速查看服务日志（最近50行）
- **批量操作**: 一键启动/停止所有服务
- **命令行模式**: 支持直接命令行调用

#### 使用方式

**交互式菜单模式**:
```powershell
pwsh -File service-manager.ps1
```

**命令行模式**:
```powershell
# 查看所有服务
pwsh -File service-manager.ps1 list

# 启动指定服务
pwsh -File service-manager.ps1 start user-service

# 停止指定服务
pwsh -File service-manager.ps1 stop user-service

# 重启指定服务
pwsh -File service-manager.ps1 restart user-service

# 查看服务日志
pwsh -File service-manager.ps1 log user-service
```

#### 菜单界面
```
========================================
      在线商城 - 服务管理工具
========================================
版本: 1.0 | 作者: lingbai

请选择操作：

  1. 查看所有服务状态
  2. 启动服务
  3. 停止服务
  4. 重启服务
  5. 查看服务日志
  6. 启动所有服务
  7. 停止所有服务
  0. 退出

请输入选项:
```

---

### 4. 完整技术文档

#### 新增文档

1. **自动服务检测指南** (`docs/AUTO_SERVICE_DETECTION.md`)
   - 系统概述和核心特性
   - 详细的启动流程图
   - 配置说明和示例
   - 故障排查指南
   - 性能优化建议
   - 扩展功能说明

2. **更新日志** (`CHANGELOG_SERVICE_AUTO_DETECTION.md`)
   - 版本历史
   - 功能对比
   - 技术实现细节
   - 使用指南

#### 更新文档

1. **README.md**
   - 添加核心特性徽章
   - 更新系统介绍
   - 突出智能化特性

2. **QUICK_START.md**
   - 新增智能启动方式说明
   - 添加服务管理章节
   - 更新服务列表表格
   - 添加新服务添加指南

---

## 📊 功能对比

| 功能项 | v1.0 | v2.0 |
|--------|------|------|
| 服务数量 | 固定4个 | 自动检测所有 |
| 新增服务 | 需修改脚本 | 自动识别 |
| 启动方式 | 手动逐个 | 智能有序启动 |
| 状态检查 | 固定列表 | 动态扫描 |
| 日志管理 | 分散 | 统一管理 |
| 服务管理 | 无 | 完整工具 |
| 扩展性 | 低 | 高 |

---

## 🔧 技术细节

### 服务发现算法

```batch
1. 扫描 backend 目录
2. 检查每个子目录是否包含 pom.xml
3. 过滤排除列表中的目录
4. 统计可启动服务数量
5. 按配置顺序启动服务
```

### 端口识别机制

```powershell
1. 优先使用预定义端口映射表
2. 如果未找到，读取 application.yml
3. 正则匹配 "port: <数字>"
4. 提取端口号并记录
```

### 服务启动顺序

| 优先级 | 服务类型 | 延迟时间 | 原因 |
|--------|----------|----------|------|
| 1 | gateway-service | 5秒 | 作为API入口，需最先启动 |
| 2 | auth-service | 3秒 | 提供认证服务 |
| 3+ | 其他业务服务 | 3秒 | 按端口顺序启动 |

---

## 📝 使用示例

### 场景1: 开发环境快速启动

```bash
# 一键启动所有服务
start-dev-silent.bat

# 等待约90秒

# 检查服务状态
pwsh -File check-services-silent.ps1

# 开始开发
```

### 场景2: 调试单个服务

```bash
# 启动基础设施
docker-compose -f docker-compose-dev.yml up -d

# 启动依赖的服务
pwsh -File service-manager.ps1 start gateway-service

# 在IDE中调试目标服务
# ...
```

### 场景3: 新增服务

```bash
# 1. 创建新服务目录
mkdir backend/notification-service

# 2. 添加 pom.xml 和源码
# ...

# 3. 配置 application.yml
cat > backend/notification-service/src/main/resources/application.yml
server:
  port: 8090
spring:
  application:
    name: notification-service

# 4. 直接启动 - 无需修改脚本！
start-dev-silent.bat
```

---

## 🚀 性能优化

### 启动时间对比

| 版本 | 启动方式 | 时间 |
|------|----------|------|
| v1.0 | 手动逐个启动 | 约5分钟 |
| v2.0 | 自动批量启动 | 约90秒 |

**提升**: 约3倍

### 资源占用

- **CPU**: 启动期间峰值约60%，稳定后约15%
- **内存**: 总计约4GB（10个微服务）
- **磁盘**: 日志约100MB/天

---

## 🔒 注意事项

### 1. 服务依赖

确保服务按正确顺序启动：
```
基础设施 → 网关 → 认证 → 业务服务
```

### 2. 端口冲突

检查端口占用：
```powershell
netstat -ano | findstr "8080"
```

### 3. 日志轮转

定期清理日志：
```powershell
# 清理7天前的日志
Get-ChildItem logs -Filter *.log | 
  Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-7)} | 
  Remove-Item
```

---

## 🐛 已知问题

### 1. Windows防火墙提示

**问题**: 首次启动时可能弹出防火墙提示  
**解决**: 点击"允许访问"

### 2. Maven下载慢

**问题**: 首次编译下载依赖较慢  
**解决**: 配置国内Maven镜像

### 3. 端口占用检测延迟

**问题**: 服务刚启动时可能检测不到  
**解决**: 等待5-10秒后再次检查

---

## 📚 相关文档

- [自动服务检测指南](docs/AUTO_SERVICE_DETECTION.md)
- [快速上手指南](QUICK_START.md)
- [开发指南](DEVELOPMENT.md)
- [项目README](README.md)

---

## 🙏 致谢

感谢所有为本项目做出贡献的开发者！

---

## 📞 技术支持

如有问题，请：
1. 查看相关文档
2. 检查服务日志
3. 运行状态检查脚本
4. 提交 Issue

---

**作者**: lingbai  
**版本**: 2.0  
**更新日期**: 2025-11-11  
**许可证**: MIT
