# 商家入驻 404 问题 - 根本修复完成报告

修复时间：2025-11-12 06:03  
状态：✅ **已从根本解决**

---

## ✅ 问题已彻底解决

商家入驻申请提交时出现的 404 错误已通过修改正确的配置文件从根本解决！

---

## 🔍 问题根源分析

### 原始错误

```
Failed to load resource: the server responded with a status of 404 (Not Found)
AxiosError: Request failed with status code 404
```

### 深层原因发现

经过详细排查，发现了**三个关键问题**：

#### 1️⃣ 修改了错误的配置文件 ❌

**问题**：

- Gateway 使用 `spring.profiles.active: simple`
- 实际生效的是 **application-simple.yml**
- 但我们修改的是 application.yml（不生效）

**结果**：

- 修改的配置没有被加载
- Gateway 仍使用旧的路由配置

#### 2️⃣ Nacos namespace 不匹配 ❌

**问题**：

- merchant-service 注册在 `simple` namespace
- Gateway 在 `public` namespace 查找服务
- 无法发现服务实例

**日志证据**：

```
merchant-service: simple registering service merchant-service
Gateway: namespace: public
```

#### 3️⃣ StripPrefix 配置错误 ❌

**问题**：原配置 `StripPrefix=2`

```
请求: /api/merchants/apply
去掉2层: /api/merchants
剩余: /apply ❌
转发: merchant-service收到 /apply（找不到该路由）
```

**正确**：应该 `StripPrefix=1`

```
请求: /api/merchants/apply
去掉1层: /api
剩余: /merchants/apply ✓
转发: merchant-service收到 /merchants/apply（匹配Controller）
```

#### 4️⃣ 缺少复数路由 ❌

**问题**：

- 只有 `/api/merchant/**`（单数）
- 缺少 `/api/merchants/**`（复数）
- 前端请求的是复数形式

---

## 🔧 根本修复措施

### 修复 1：修改正确的配置文件 ✅

**文件**：`backend/gateway-service/src/main/resources/application-simple.yml`

**关键点**：

- ✅ 这才是实际生效的配置文件
- ✅ 因为 `spring.profiles.active: simple`

### 修复 2：统一 Nacos namespace ✅

**修改**：

```yaml
# application-simple.yml
spring:
  cloud:
    nacos:
      discovery:
        namespace: simple # 从 public 改为 simple
```

**结果**：

- ✅ Gateway 现在在 simple namespace 查找服务
- ✅ 可以正确发现 merchant-service

### 修复 3：修正 StripPrefix 配置 ✅

**修改**：

```yaml
# 商家服务（单数）
- id: merchant-service
  predicates:
    - Path=/api/merchant/**
  filters:
    - StripPrefix=1 # 从 2 改为 1
```

**路径转换**：

```
/api/merchant/xxx -> /merchant/xxx ✓
```

### 修复 4：添加复数路由 ✅

**新增**：

```yaml
# 商家服务（复数）- 支持 /api/merchants/** 路径
- id: merchant-service-plural
  uri: lb://merchant-service
  predicates:
    - Path=/api/merchants/**
  filters:
    - StripPrefix=1
```

**路径转换**：

```
/api/merchants/apply -> /merchants/apply ✓
```

### 修复 5：SecurityConfig 白名单 ✅

**文件**：`backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java`

**修改**：

```java
.requestMatchers("/merchants/apply").permitAll()
.requestMatchers("/merchants/applications/**").permitAll()
```

---

## 📋 测试验证

### ✅ 通过 Gateway 访问测试

**请求**：

```bash
POST http://localhost:8080/api/merchants/apply
Content-Type: application/json

{
  "shopName": "最终测试",
  "entityType": "individual",
  "contactName": "测试",
  "contactPhone": "13800138000",
  ...
}
```

**响应**：

```json
{
  "code": 200,
  "success": true,
  "message": "申请提交成功，请等待审核",
  "data": {
    "applicationId": 1762898621700,
    "status": "pending",
    "shopName": "最终测试",
    "submittedAt": "2025-11-12T06:03:41.700"
  }
}
```

**状态码**：✅ **200 OK**

---

## 🎯 完整的请求流程

```
浏览器 http://localhost:5173
    ↓
前端Vue应用
    ↓ 提交表单
API调用: /api/merchants/apply
    ↓
Vite代理
    ↓ 转发到
Gateway (http://localhost:8080)
    ↓ 接收请求
/api/merchants/apply
    ↓ 路由匹配
merchant-service-plural路由
    - 匹配: /api/merchants/**
    - StripPrefix=1
    ↓ 去掉/api
/merchants/apply
    ↓ Nacos服务发现
在simple namespace查找merchant-service
    ↓ 找到实例
10.102.43.93:8087
    ↓ 负载均衡转发
merchant-service (http://localhost:8087)
    ↓ SecurityConfig检查
/merchants/apply - permitAll() ✓
    ↓ Controller处理
@PostMapping("/apply")
MerchantApplicationController
    ↓ 返回响应
200 OK - 申请提交成功 ✅
```

---

## 📊 服务状态

**所有服务运行正常：10/10** ✅

| 服务名称             | 端口 | 状态     | Nacos 注册 |
| -------------------- | ---- | -------- | ---------- |
| gateway-service      | 8080 | ✓ 运行中 | ✓ simple   |
| auth-service         | 8081 | ✓ 运行中 | ✓ simple   |
| user-service         | 8082 | ✓ 运行中 | ✓ simple   |
| product-service      | 8083 | ✓ 运行中 | ✓ simple   |
| order-service        | 8084 | ✓ 运行中 | ✓ simple   |
| payment-service      | 8085 | ✓ 运行中 | ✓ simple   |
| admin-service        | 8086 | ✓ 运行中 | ✓ simple   |
| **merchant-service** | 8087 | ✓ 运行中 | ✓ simple   |
| cart-service         | 8088 | ✓ 运行中 | ✓ simple   |
| sms-service          | 8089 | ✓ 运行中 | ✓ simple   |

---

## 🎯 如何测试

### 方式 1：浏览器测试（推荐）

1. **访问商家入驻页面**

   ```
   http://localhost:5173/merchant/register
   ```

2. **填写入驻表单**

   - 选择主体类型（个人/企业）
   - 填写店铺信息
   - 填写联系方式
   - 上传必要证件

3. **点击提交申请**
   - 应该看到：**"申请提交成功！我们将在 1 个工作日内完成审核"**
   - 自动跳转到商家登录页面

### 方式 2：API 直接测试

```bash
# 通过Gateway
curl -X POST http://localhost:8080/api/merchants/apply \
  -H "Content-Type: application/json" \
  -d '{"shopName":"测试店铺","entityType":"individual","contactName":"张三","contactPhone":"13800138000","email":"test@qq.com","username":"test001","password":"123456","idCard":"110101199001011234","idCardFront":"http://test.jpg","idCardBack":"http://test.jpg"}'

# 直接访问merchant-service
curl -X POST http://localhost:8087/merchants/apply \
  -H "Content-Type: application/json" \
  -d '{"shopName":"测试店铺","entityType":"individual",...}'
```

---

## 📝 修改的文件

### 1. backend/gateway-service/src/main/resources/application-simple.yml

```yaml
# 修改1: Nacos namespace
discovery:
  namespace: simple  # public -> simple

# 修改2: 商家服务路由
- id: merchant-service
  predicates:
    - Path=/api/merchant/**
  filters:
    - StripPrefix=1  # 2 -> 1

# 修改3: 新增复数路由
- id: merchant-service-plural
  uri: lb://merchant-service
  predicates:
    - Path=/api/merchants/**
  filters:
    - StripPrefix=1
```

### 2. backend/merchant-service/src/main/java/com/mall/merchant/config/SecurityConfig.java

```java
.requestMatchers("/merchants/apply").permitAll()
.requestMatchers("/merchants/applications/**").permitAll()
```

### 3. 已重启的服务

- ✅ gateway-service (8080) - 3 次重启
- ✅ merchant-service (8087) - 1 次重启

---

## ⚠️ 重要经验教训

### 1. Spring Profiles 配置优先级

```
application-{profile}.yml  >  application.yml
```

- 当 `spring.profiles.active: simple` 时
- 优先加载 `application-simple.yml`
- 其次加载 `application.yml`
- 相同配置会被覆盖

### 2. StripPrefix 配置规则

```
路径: /api/merchants/apply

StripPrefix=1: 去掉 /api        -> /merchants/apply ✓
StripPrefix=2: 去掉 /api/merchants -> /apply ❌
```

### 3. Nacos Namespace 必须一致

```
服务注册: namespace=simple
服务发现: namespace=simple  ✓ 匹配

服务注册: namespace=simple
服务发现: namespace=public  ❌ 不匹配（找不到服务）
```

---

## ✅ 最终状态

### 系统完全就绪

- ✅ 所有 10 个微服务运行正常
- ✅ Gateway 路由配置正确
- ✅ Nacos 服务注册正常
- ✅ 安全配置允许公开访问
- ✅ API 测试通过 (HTTP 200)

### 可以进行的测试

1. ✅ 商家入驻申请提交
2. ✅ 申请列表查询
3. ✅ 申请详情查看
4. ✅ 管理员审批功能
5. ✅ 审批结果通知

---

## 🎉 修复完成

**问题已从根本解决，无需任何临时方案！**

现在可以：

1. 直接在浏览器中访问 `http://localhost:5173/merchant/register`
2. 填写并提交商家入驻申请
3. 请求会通过 Gateway 正确路由到 merchant-service
4. 系统返回成功响应

**修复完成时间**：2025-11-12 06:03  
**修复状态**：✅ **根本问题已解决，系统完全就绪**
